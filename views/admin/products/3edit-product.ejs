<style>
    .main-content {
        margin-left: 250px;
        margin-top: 70px;
        padding: 2rem;
        min-height: calc(100vh - 120px);
        background-color: #f8f9fa;
        color: #333;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .error-message {
        color: red;
        font-size: smaller;
    }
</style>

<!-- cropper JS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<%-include ('../../../views/partials/admin/header')%>


    <section class="main-content">
        <div class="container border">
            <div class="row">
                <h2 class="h1 text-center">Edit Product</h2>
            </div>
            <form id="editForm" method="post">

                <div class="row">
                    <div class="col-4">
                        <label for="productName" class="form-label">Product Name</label>
                        <input type="text" placeholder="Type here" 
                            name="productName" class="form-control border" 
                            id="productName" value="<%= product.productName %>">
                        <div id="productName-error" class="error-message"></div>
                    </div>

                    <div class="col-4">
                        <label class="form-label">Brand</label>
                        <select class="form-select border" name="brand">
                            <% for(let i=0;i< brand.length;i++){ %>
                                <option value="<%= brand[i].brandName %>" <%= brand[i].brandName === product.brand ? 'selected' : '' %> >
                                    <%= brand[i].brandName %>
                                </option>
                                <%}%>
                        </select>
                        <div id="brand-error" class="error-message"></div>
                    </div>

                    <div class="col-4">
                        <label class="form-label">Category</label>
                        <select class="form-select border" name="category">
                        <% for(let i=0;i< category.length;i++){ %>
                            <option value="<%= category[i].name %>" <%= category[i].name === product.category ? 'selected' : '' %>>
                                <%= category[i].name %>
                            </option>
                            <% } %>
                        </select>
                        <div id="category-error" class="error-message"></div>
                    </div>

                </div>
                
                <div class="row">
                    <div class="col">
                        <label class="form-label">Full description</label>
                        <textarea placeholder="Type here" name="productDescription" 
                                class="form-control border"rows="4"> <%= product.description %></textarea>
                        <div id="description-error" class="error-message"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-3">
                        <label class="form-label">Regular price</label>
                        <input placeholder="â‚¹" name="regularPrice" 
                            type="text" class="form-control border" value="<%= product.regularPrice %>">
                        <div id="regularPrice-error" class="error-message"></div>
                    </div>


                    <div class="col-3">
                        <label class="form-label">Sale price</label>
                        <input placeholder="â‚¹" name="salePrice" 
                            type="text" class="form-control border" value="<%= product.salePrice %>">
                        <div id="salePrice-error" class="error-message"></div>
                    </div>

                    
                    <div class="col-3">
                        <label class="form-label">Quantity</label>
                        <input placeholder="" name="quantity" 
                            type="text" class="form-control border" value="<%= product.quantity %>">
                        <div id="quantity-error" class="error-message"></div>
                    </div>

                    <div class="col-3">
                        <label class="form-label">Color</label>
                        <input name="color" type="text" class="form-control border" value="<%= product.color %>">
                        <div id="color-error" class="error-message"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <h1 class="h3">Current Images:</h1>
                    </div>

                    <div class="row" id="existingImages">
                        <% product.productImage.forEach((img) => { %>
                            <div class="image-box">
                                <img src="<%= img.url %>" width="300">
                                <button type="button" class="removeImageBtn btn btn-outline-danger">Remove</button>
                            </div>
                            <br>-<br>
                        <% }) %>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <h4>Add New Images:</h4>
                        <input type="file" id="newImages" multiple accept="image/*">
                        <div id="cropContainer" style="width: 500px;"></div> <!-- where CropperJS will show image -->
                        <div id="previewContainer" class="d-flex flex-wrap gap-2 mt-3"></div>
                    </div>
                </div>

                <!-- Hidden input to send removed image IDs -->
                <input type="hidden" name="removedImages" id="removedImages">



                <div class="row">
                    <div class="row justify-content-center">
                        <button class="w-50 bg-success text-white btn" type="submit" id="submitBtn">Update Product</button>
                    </div> 
                </div>
            </form>
        </div>
    </section>

    
<%-include ('../../../views/partials/admin/footer')%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<!-- <script>
    let currentImages=[...<%- JSON.stringify(product.productImage) %>];
    //no problem if we don't copy the array.but it's better to copy.it doesn't make change in the original array if we make change in this copied array.

    //product.images is look like ['img1.jpg','img2.jpg']/ it is server side JS array, browser doesn't understand server side.it only uderstands client side.
    //if we write like >>> let currentImages=[...<%-product.images%>].
    //the currentImages look like=[img1.jpg,img2.jpg]. no quotes for the elements.so elements are not strings.it is like variables
    //so browser thinks that elements(img1.jpg,img2.jpg) are like variables, browser looks for that not exisiting variables.and throw error.

    //we need array element with quotes like ['img1.jpg','img2.jpg'].
    //that is why we use JSON.stringify. so it helps to convert the server side array to JS literal.adds quotes around strings.
    //for example: server side array==>['img1.jpg'] .if we use JSON.stringify(product.images) the array looks like ===> '["img1.jpg"]' 
    //if we don't use it will look like==>[img1.jpg], so browser thinks that is a variable.

    // Why use <%- %> instead of <%= %>?
    //if we use <%= %>. the array looks like ==>["img1.jpg", &quot;img2.jpg&quot;].this is escaped output
    //we need the array as it is and unescaped, that is why use <%- %>
    //for example: let's say user.name=<p>hello</p>

    //if we use <..%=user.name %>. the output look like ==>&lt;p&gt;hello&lt;p&gt;
    //if we use <..%- user.name %>. the output looks like ==><p>hello</p>


    //maximum number of image uplaod is 4. so excess <input> tags are making disabled.
    //  to prevent uplaod images more than 4
    for(let i=currentImages.length-1; i>=0; i--){
                const imageInputField=document.getElementById('imageInputField'+i);
                imageInputField.disabled=true;
            }

    //handle remove current image
    document.querySelectorAll('.removeImageBtn').forEach(btn =>{
        btn.addEventListener('click',async ()=>{
            const confirmDelete= await Swal.fire({
                title:"Are you sure want to remove this image?",
                icon:"warning",
                showCancelButton:true,
                confirmButtonText:"Yes, remove",
                cancelButtonText:"Cancel"
            })
            if(!confirmDelete.isConfirmed) return;

            const filename=btn.dataset.filename; //name of the removing image
            const container=btn.closest('.image-box');
            container.remove();
            currentImages=currentImages.filter(img=>img!==filename);//filenames that are not match with removed image, will returned.(used to track which images are still kept).
            for(let i=0; i<4-currentImages.length ; i++){
                const imageInputField=document.getElementById('imageInputField'+i);
                imageInputField.disabled=false;
            }
        })
    })
    
    const croppedImages=new Array(4).fill(null);

    for(let i=0;i<4;i++){
        const input=document.getElementById('imageInputField'+i);
        const preview=document.getElementById('preview'+i);

        input.addEventListener('change',()=>{
            console.log("started working.....")
            console.log("preview:",preview)

            if(!input.files || !input.files[0])  return;

            const file=input.files[0];
            if (!file.type.startsWith('image/')){
                Swal.fire("Choose an image file","","error")
                input.value='';
                    return;
            }
            const reader=new FileReader();

            reader.onload=()=>{
                const img=document.createElement('img');
                img.src=reader.result;
                img.style.maxWidth='200px';
                preview.appendChild(img);

                //making cropping tool on the selected image by <input> tag
                const cropper=new Cropper(img,{
                    aspectRatio:1,
                    viewMode:1,
                    autoCropArea:1
                });

                const cropBtn=document.createElement('button');
                cropBtn.textContent="Crop & Save";
                cropBtn.type='button';
                preview.appendChild(cropBtn);


                cropBtn.onclick=()=>{
                    const canvas =cropper.getCroppedCanvas({width:500,height:500});
                    canvas.toBlob(blob=>{
                        croppedImages[i]={blob,name:file.name};
                        preview.innerHTML='';


                        const croppedImg=document.createElement('img');
                        croppedImg.src=URL.createObjectURL(blob);
                        croppedImg.style.width='100px';
                        preview.appendChild(croppedImg);


                        const removeBtn=document.createElement('button');
                        removeBtn.textContent="Remove";
                        removeBtn.type='button';
                        removeBtn.onclick=()=>{
                            croppedImages[i]=null;
                            input.value='';
                            preview.innerHTML='';
                        }
                        preview.appendChild(removeBtn);
                    })
                }
            }

            reader.readAsDataURL(file);
        })
    }

    const form = document.getElementById('editForm');
    form.addEventListener('submit',(event)=>{
        event.preventDefault();

        const totalImages=currentImages.length+croppedImages.filter(Boolean).length;
        const productName=document.getElementsByName('productName')[0].value;
        const brand = document.getElementsByName('brand')[0].value;
        const productDescription=document.getElementsByName('productDescription')[0].value;
        const price = document.getElementsByName('regularPrice')[0].value;
        const saleprice = document.getElementsByName('salePrice')[0].value;
        const quantity = document.getElementsByName('quantity')[0].value;
        const color = document.getElementsByName('color')[0].value;
        const category = document.getElementsByName('category')[0].value;


        clearErrorMessages();//clearing all the current error messages


        if (productName.trim() === "") {
            console.log("productName:",productName);
            displayErrorMessage('productName-error', 'Please enter a product name.');
            return;
        }
         // Validate Product Name: allow letters, spaces, hyphens, apostrophes, and basic international characters
        if (!/^[A-Za-zÃ€-Ã¿\s'-]+$/.test(productName.trim())) {
            displayErrorMessage('productName-error', 'Product name should contain only letters, spaces, hyphens, or apostrophes.');
            event.preventDefault();
            return;
        }

        // Validate Product Description: allow letters, numbers, punctuation, spaces, and basic symbols
        if (productDescription.trim() === "") {
            displayErrorMessage('description-error', 'Please enter a product description.');
            event.preventDefault();
            return;
        }

        if (!/^[\wÃ€-Ã¿0-9\s.,!'"%():;?-]+$/.test(productDescription.trim())) {
            displayErrorMessage('description-error', 'Product description contains invalid characters.');
            event.preventDefault();
            return;
        }

        if (quantity.trim()==="" || parseInt(quantity) < 0) {
            displayErrorMessage('quantity-error', 'Please enter a valid non-negative quantity.');
            return;
        }

        if (price.trim()==="" || !/^\d+(\.\d{1,2})?$/.test(price) || parseFloat(price) < 0) {
            displayErrorMessage('regularPrice-error', 'Please enter a valid non-negative price.');
            return;
        }

        if (saleprice.trim()==="" || !/^\d+(\.\d{1,2})?$/.test(saleprice) || parseFloat(saleprice) < 0) {
            displayErrorMessage('salePrice-error', 'Please enter a valid non-negative price.');
            return;
        }
        if (parseFloat(price) <= parseFloat(saleprice)) {
            displayErrorMessage('regularPrice-error', 'Regular price must be greater than sale price.');
            return;
        }

        if (color.trim() === "") {
            displayErrorMessage('color-error', 'Please enter a color.');
            return;
        }

        if(totalImages<3){
            displayErrorMessage("input-field-error","Minimum 3 images are required");
            return;
        }

        if(totalImages>4){
            displayErrorMessage("input-field-error","Maximum 4 images are required");
            return;
        }

        const formData=new FormData(form);
        formData.append('existingImages',JSON.stringify(currentImages));

        //croppedImages looks like ====>[{blob:Blob,name:'imgName.jpg'},{..}]
        croppedImages.forEach(item=>{
            if(item){
                formData.append('images',item.blob,item.name);
            }
            console.log(formData)
        });



        fetch(form.action,{
            method:'POST',
            body:formData,
        }).then(res=>{
            if(res.ok){
                // alert("Product updated successfully");
                Swal.fire({
                    title:"Done",
                    text:"Product updated Successfully",
                    icon:"success",
                    timer:1500
                }).then(()=>{
                    window.location.href='/admin/products';
                })
                
            }else{
                // alert("Failed to update product");
                Swal.fire({title:"Failed",text:res.message,icon:"error"})
            }
        })
    })

    function displayErrorMessage(elementId, message) {
        var errorElement = document.getElementById(elementId);
        errorElement.innerText = message;
        errorElement.style.display = "block";
    }

    function clearErrorMessages() {
        const errorElements = document.getElementsByClassName('error-message');
        Array.from(errorElements).forEach(element => {
            element.innerHTML = "";
        });
    }
</script> -->

<script>
document.addEventListener("DOMContentLoaded", function() {

    const existingImages = document.getElementById("existingImages");
    const removedImagesInput = document.getElementById("removedImages");
    const newImagesInput = document.getElementById("newImages");
    const previewContainer = document.getElementById("previewContainer");
    let removedImages = [];
    let croppedImages = [];

    // ðŸ§¹ STEP 1: Handle Removing Existing Images
    existingImages.addEventListener("click", async (e) => {
        const confirmDelete= await Swal.fire({
                title:"Are you sure want to remove this image?",
                icon:"warning",
                showCancelButton:true,
                confirmButtonText:"Yes, remove",
                cancelButtonText:"Cancel"
            })
            if(!confirmDelete.isConfirmed) return;

        if (e.target.classList.contains("removeImageBtn")) {
            const imageBox = e.target.closest(".image-box");
            const imgElement = imageBox.querySelector("img");
            const imgUrl = imgElement.getAttribute("src");

            removedImages.push(imgUrl); // store to send to backend
            imageBox.remove(); // remove from UI
            removedImagesInput.value = JSON.stringify(removedImages);
        }
    });


    // ðŸ“¸ STEP 2: Handle New Image Selection
    newImagesInput.addEventListener("change", function(event) {
        const files = event.target.files;
        Array.from(files).forEach((file) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                showCropper(e.target.result, file.name);
            };
            reader.readAsDataURL(file);
        });
    });

    // ðŸŒ¾ STEP 3: Show CropperJS for selected image
    function showCropper(imageSrc, filename) {
        const cropContainer = document.getElementById("cropContainer");
        cropContainer.innerHTML = `
            <div class="crop-box">
                <img id="cropImage" src="${imageSrc}" style="max-width:100%;">
                <div class="mt-2">
                    <button type="button" class="btn btn-success" id="saveCrop">Save Crop</button>
                    <button class="btn btn-secondary" id="cancelCrop">Cancel</button>
                </div>
            </div>
        `;

        const image = document.getElementById("cropImage");
        const cropper = new Cropper(image, {
            aspectRatio: 1, // You can change this
            viewMode: 1,
        });

        document.getElementById("saveCrop").addEventListener("click", () => {
            cropper.getCroppedCanvas().toBlob((blob) => {
                const croppedFile = new File([blob], filename, { type: "image/jpeg" });
                const url = URL.createObjectURL(blob);

                croppedImages.push(croppedFile); // store cropped file

                // Show cropped preview
                const previewBox = document.createElement("div");
                previewBox.classList.add("position-relative", "d-inline-block");
                previewBox.innerHTML = `
                    <img src="${url}" width="100">
                    <button class="btn btn-danger btn-sm position-absolute top-0 end-0 removeNewBtn">X</button>
                `;
                previewContainer.appendChild(previewBox);

                cropContainer.innerHTML = ""; // clear cropper
            });
        });

        document.getElementById("cancelCrop").addEventListener("click", () => {
            cropContainer.innerHTML = "";
        });
    }


    // ðŸ§º STEP 4: Remove cropped preview
    previewContainer.addEventListener("click", (e) => {
        if (e.target.classList.contains("removeNewBtn")) {
            const box = e.target.closest("div");
            const index = Array.from(previewContainer.children).indexOf(box);
            croppedImages.splice(index, 1); // remove from list
            box.remove();
        }
    });


    // ðŸš€ STEP 5: Handle Form Submission via AJAX
    const form = document.getElementById("editForm");
    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const submitBtn=document.getElementById('submitBtn');
        submitBtn.innerText="Updating....."

        const productName=document.getElementsByName('productName')[0].value;
        const brand = document.getElementsByName('brand')[0].value;
        const productDescription=document.getElementsByName('productDescription')[0].value;
        const price = document.getElementsByName('regularPrice')[0].value;
        const saleprice = document.getElementsByName('salePrice')[0].value;
        const quantity = document.getElementsByName('quantity')[0].value;
        const color = document.getElementsByName('color')[0].value;
        const category = document.getElementsByName('category')[0].value;

        clearErrorMessages();//clearing all the current error messages


        if (productName.trim() === "") {
            console.log("productName:",productName);
            displayErrorMessage('productName-error', 'Please enter a product name.');
            return;
        }
         // Validate Product Name: allow letters, spaces, hyphens, apostrophes, and basic international characters
        if (!/^[A-Za-zÃ€-Ã¿\s'-]+$/.test(productName.trim())) {
            displayErrorMessage('productName-error', 'Product name should contain only letters, spaces, hyphens, or apostrophes.');
            event.preventDefault();
            return;
        }

        // Validate Product Description: allow letters, numbers, punctuation, spaces, and basic symbols
        if (productDescription.trim() === "") {
            displayErrorMessage('description-error', 'Please enter a product description.');
            event.preventDefault();
            return;
        }

        if (!/^[\wÃ€-Ã¿0-9\s.,!'"%():;?-]+$/.test(productDescription.trim())) {
            displayErrorMessage('description-error', 'Product description contains invalid characters.');
            event.preventDefault();
            return;
        }

        if (quantity.trim()==="" || parseInt(quantity) < 0) {
            displayErrorMessage('quantity-error', 'Please enter a valid non-negative quantity.');
            return;
        }

        if (price.trim()==="" || !/^\d+(\.\d{1,2})?$/.test(price) || parseFloat(price) < 0) {
            displayErrorMessage('regularPrice-error', 'Please enter a valid non-negative price.');
            return;
        }

        if (saleprice.trim()==="" || !/^\d+(\.\d{1,2})?$/.test(saleprice) || parseFloat(saleprice) < 0) {
            displayErrorMessage('salePrice-error', 'Please enter a valid non-negative price.');
            return;
        }
        if (parseFloat(price) <= parseFloat(saleprice)) {
            displayErrorMessage('regularPrice-error', 'Regular price must be greater than sale price.');
            return;
        }

        if (color.trim() === "") {
            displayErrorMessage('color-error', 'Please enter a color.');
            return;
        }

        const formData = new FormData(form);
        croppedImages.forEach((file) => {
            formData.append("newImages", file);
        });

        fetch("/admin/edit-product/<%= product._id %>", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                Swal.fire({title:"Product updated successfully!",showConfirmButton:true,timer:5000,icon:"success"})
                    .then(()=>{window.location.href='/admin/products'});
            } else {
                Swal.fire({
                    icon:"error",
                    title:data.message,
                })
            }
        })
        .catch(err => console.error(err));
    });

});

    function displayErrorMessage(elementId, message) {
        var errorElement = document.getElementById(elementId);
        errorElement.innerText = message;
        errorElement.style.display = "block";
    }

    function clearErrorMessages() {
        const errorElements = document.getElementsByClassName('error-message');
        Array.from(errorElements).forEach(element => {
            element.innerHTML = "";
        });
    }
</script>
