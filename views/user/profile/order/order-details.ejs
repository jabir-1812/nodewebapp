<%-include ('../../../../views/partials/user/header')%>

<%-include ('../../../../views/user/profile/profile-partials/sidebar')%>

<style>
    /* Main Container */
    .main-content {
        margin-left: 220px; /* sidebar width */
        padding: 90px 30px 30px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
        min-height: 100vh;
    }

    /* Order Details Card */
    .order-details {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 30px;
    }

    .order-details h2 {
        color: #2c3e50;
        font-size: 28px;
        margin-bottom: 25px;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
    }

    .order-details h3 {
        color: #34495e;
        font-size: 20px;
        margin-top: 30px;
        margin-bottom: 15px;
        font-weight: 600;
    }

    /* Order Summary Box */
    .order-summary {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
    }

    .order-summary p {
        margin: 10px 0;
        font-size: 16px;
        color: #555;
    }

    .order-summary strong {
        color: #2c3e50;
        font-weight: 600;
    }

    /* Status Colors */
    .text-danger { color: #e74c3c !important; font-weight: 600; }
    .text-success { color: #27ae60 !important; font-weight: 600; }
    .text-primary { color: #3498db !important; font-weight: 600; }
    .text-info { color: #17a2b8 !important; font-weight: 600; }
    .text-warning { color: #f39c12 !important; font-weight: 600; }

    /* Shipping Address */
    .shipping-address {
        background: #fff9e6;
        border: 2px solid #f39c12;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .shipping-address p {
        margin: 8px 0;
        color: #555;
        font-size: 15px;
    }

    /* Order Items */
    .order-items {
        margin-top: 20px;
    }

    .item {
        display: flex;
        gap: 20px;
        background: white;
        border: 2px solid #ecf0f1;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .item:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .item img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #ecf0f1;
    }

    .item-info {
        flex: 1;
    }

    .item-info h4 {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .item-info p {
        margin: 8px 0;
        color: #666;
        font-size: 14px;
    }

    /* Buttons */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        margin-top: 10px;
        margin-right: 10px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
        background: #3498db;
        color: white;
    }

    .btn-primary:hover {
        background: #2980b9;
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
    }

    .btn-danger:hover {
        background: #c0392b;
    }

    .btn-warning {
        background: #f39c12;
        color: white;
    }

    .btn-warning:hover {
        background: #e67e22;
    }

    /* Forms */
    .cancel-form, .return-form, #cancelOrderForm {
        display: inline-block;
        margin-top: 10px;
    }

    #cancelOrderForm {
        margin-top: 30px;
        text-align: center;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .main-content {
            margin-left: 0;
            padding: 20px 15px;
        }

        .order-details {
            padding: 20px;
        }

        .item {
            flex-direction: column;
        }

        .item img {
            width: 100%;
            height: 200px;
        }
    }

    /* Price Highlight */
    .order-summary p:last-child {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        text-align: center;
    }

    /* Invoice Button Special Style */
    .btn-primary[href*="invoice"] {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 24px;
        font-size: 15px;
        margin-top: 20px;
        margin-bottom: 20px;
    }
</style>

<div class="main-content">
    <div class="order-details">
        <h2>üì¶ Order Details</h2>

        <div class="order-summary">
            <p><strong>Order ID:</strong> <%= order.orderId %></p>
            <p>
                <strong>Status:</strong> 
                <span class="<%= 
                    order.orderStatus === 'Cancelled' ? 'text-danger' : 
                    order.orderStatus === 'Delivered' ? 'text-success' : 
                    order.orderStatus === 'Shipped' ? 'text-primary' : 
                    order.orderStatus === 'Out for Delivery' ? 'text-info' : 
                    order.orderStatus === 'Pending' ? 'text-warning' : 
                    '' 
                %>">
                    <%= order.orderStatus %>
                </span>
                <% if(order.orderStatus==="Delivered"){ %>
                    - On <%= new Date(order.deliveredOn).toDateString().slice(4) %>
                <%}%>
            </p>

            <p><strong>Placed on:</strong> <%= new Date(order.createdAt).toDateString() %></p>
            <p><strong>Payment:</strong> <%= order.paymentMethod %> ( <%= order.paymentStatus %> )</p>
            <% if(order.refundStatus==="Refunded" || order.refundStatus==="Refunded to your wallet"){ %>
            <p><strong>Refund Status:</strong> <%= order.refundStatus %></p>
            <% } %>
            <p><strong style="color: white;">Total:</strong><strong style="font-size: x-large; color: white;">‚Çπ<%= order.totalAmount %>/-</strong></p>
        </div>

        <h3>üìç Shipping Address</h3>
        <div class="shipping-address">
            <p><strong><%= order.shippingAddress.name %></strong></p>
            <p><%= order.shippingAddress.landMark %>, <%= order.shippingAddress.city %></p>
            <p><%= order.shippingAddress.state %> - <%= order.shippingAddress.pincode %></p>
            <p>üìû Phone: <%= order.shippingAddress.phone %></p>
        </div>
        
        <% if (order.invoice && order.invoice.generated) { %>
        <a href="/orders/<%= order._id %>/invoice" class="btn btn-primary">
            üìÑ Download Invoice
        </a>
        <% } %>


        <h3>üõçÔ∏è Items</h3>
        <div class="order-items">
            <% order.orderItems.forEach(item => { %>
                <div class="item">
                <img src="<%= item.productImage %>" alt="<%= item.productName %>">
                <div class="item-info">
                    <h4><%= item.productName %></h4>
                    <p><strong>‚Çπ<%= item.price.toFixed(2) %>/-</strong> | Qty: <%= item.quantity %></p>
                    <p>
                        <strong>Delivery Status:</strong>
                        <span class="<%= 
                            item.itemStatus === 'Cancelled' ? 'text-danger' : 
                            item.itemStatus === 'Delivered' ? 'text-success' : 
                            item.itemStatus === 'Shipped' ? 'text-primary' : 
                            item.itemStatus === 'Out for Delivery' ? 'text-info' : 
                            item.itemStatus === 'Pending' ? 'text-warning' : 
                            '' 
                        %>">
                            <%= item.itemStatus %>
                        </span>
                        <% if(item.itemStatus==="Delivered"){ %>
                           - On <%= new Date(item.deliveredOn).toDateString().slice(4) %>
                        <%}%>
                    </p>

                        <% if (item.returnStatus && item.returnStatus !== "None") { %>
                    <p>
                            <strong>Return Status:</strong>
                            <span class="<%= 
                                item.returnStatus === 'Requested' ? 'text-warning' : 
                                item.returnStatus === 'Approved' ? 'text-info' : 
                                item.returnStatus === 'Rejected' ? 'text-danger' : 
                                item.returnStatus === 'Completed' ? 'text-success' : 
                                '' 
                            %>">
                            <%= item.returnStatus %>
                            </span>
                    </p>
                    <p><strong>Return Reason:</strong> <%= item.returnReason %></p>
                        <% } %>

                        <% if(item.refundStatus==="Refunded"){ %>
                        <p><strong>Refund Status:</strong> <%= item.refundStatus %></p>
                        <p><strong>Refunded On:</strong> <%= new Date(item.refundedOn).toDateString().slice(4) %></p>
                        <% } %>

                    <% if (item.itemStatus === "Pending") { %>
                       <form class="cancel-form">
                            <input type="hidden" name="orderId" value="<%= order.orderId %>">
                            <input type="hidden" name="itemId" value="<%= item._id %>">
                            <button type="submit" class="btn btn-danger">‚ùå Cancel Item</button>
                        </form>
                    <% } %>

                   <% if (item.itemStatus === "Delivered" && (!item.returnStatus || item.returnStatus === "None")) { %>
                    <form class="return-form">
                        <input type="hidden" name="orderId" value="<%= order.orderId %>">
                        <input type="hidden" name="itemId" value="<%= item._id %>">
                        <button type="submit" class="btn btn-warning">‚Ü©Ô∏è Return Item</button>
                    </form>
                    <% } %>
                </div>
                </div>
            <% }) %>
            </div>

            <%
                const hasRestrictedStatus = order.orderItems.some(
                    item => ["Shipped", "Delivered", "Out for Delivery"].includes(item.itemStatus)
                );
            %>

            <% if (!hasRestrictedStatus && (order.orderStatus === "Pending" || order.orderStatus === "Partially Cancelled")) { %>
            <form id="cancelOrderForm">
                <input type="hidden" name="orderId" value="<%= order.orderId %>">
                <button type="submit" class="btn btn-danger">‚ùå Cancel Entire Order</button>
            </form>
            <% } %>
    </div>
</div>


<script>
    // document.querySelectorAll(".cancel-form").forEach(form => {
    //     form.addEventListener("submit", async (e) => {
    //             e.preventDefault();

    //             const confirmResult=await Swal.fire({
    //                 title:"Are you sure, Cancel this order?",
    //                 icon:'question',
    //                 showConfirmButton:true,
    //                 showCancelButton:true
    //             })

    //             if (!confirmResult.isConfirmed) return;

    //             const formData = new FormData(form);
    //             const data = Object.fromEntries(formData.entries());

    //             const response = await fetch("/user-profile/orders/order-details/cancel-item", {
    //             method: "POST",
    //             headers: { "Content-Type": "application/json" },
    //             body: JSON.stringify(data)
    //             });

    //             const result = await response.json();
    //             console.log("result=====>",result)
    //             if (result.success) {
    //                 Swal.fire({
    //                     title:"Done",
    //                     text:result.message,
    //                     icon:"success",
    //                     timer:2000
    //                 })
    //                 .then(()=>{
    //                     location.reload();
    //                 })
    //             } else {
    //             Swal.fire("Oops!",result.message,"error")
    //             }
    //         });
    //     });


        document.querySelectorAll(".cancel-form").forEach(form => {
        form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const confirmResult=await Swal.fire({
                    title:"Are you sure, Cancel this order?",
                    icon:'question',
                    showConfirmButton:true,
                    showCancelButton:true
                })

                if (!confirmResult.isConfirmed) return;

                let confirmReason=await Swal.fire({
                    title:"Why are you canceling this order ?",
                    input:"select",
                    inputOptions:{
                        "Ordered the wrong item":"Ordered the wrong item",
                        "Found a better price elsewhere":"Found a better price elsewhere",
                        "Product no longer needed":"Product no longer needed",
                        "Changed my mind about the purchase":"Changed my mind about the purchase",
                        "Quantity or size was incorrect":"Quantity or size was incorrect",
                        "other":"other"
                    },
                    inputPlaceholder:"Select a reason",
                    showCancelButton:true,
                    inputValidator:(value)=>{
                        if(!value){
                            return "‚ö†Ô∏è Please select a reason before continuing!";
                        }
                    }
                });

                if(!confirmReason.isConfirmed) return;
                let reason=confirmReason.value;

                if(reason==="other"){
                    const customReason = await Swal.fire({
                        title:"Please specify your reason",
                        input:"textarea",
                        inputPlaceholder:"Type your reason here...",
                        inputAttributes:{'aria-label':'Cancellation reason'},
                        showCancelButton:true,
                        inputValidator:(value)=>{
                            if(!value.trim()){
                                return "‚ö†Ô∏è Please enter a reason"
                            }
                        }
                    })
                    if(!customReason.isConfirmed) return;
                    reason=customReason.value;
                }

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.reason=reason;

                const response = await fetch("/user-profile/orders/order-details/cancel-item", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log("result=====>",result)
                if (result.success) {
                    Swal.fire({
                        title:"Done",
                        text:result.message,
                        icon:"success",
                        timer:2000
                    })
                    .then(()=>{
                        location.reload();
                    })
                } else {
                Swal.fire("Oops!",result.message,"error")
                }
            });
        });
</script>

<script>
    const cancelOrderForm=document.getElementById('cancelOrderForm');
    cancelOrderForm.addEventListener('submit',async (e)=>{
        e.preventDefault()
        // console.log("form prevented")
        const confirmResult=await Swal.fire({
            title:"Are you sure, Cancel Whole order ?",
            showConfirmButton:true,
            showCancelButton:true,
            icon:"question"
        })

        if(!confirmResult.isConfirmed) return;

        let confirmReason=await Swal.fire({
            title:"Why are you canceling this order ?",
            input:"select",
            inputOptions:{
                "Ordered the wrong item":"Ordered the wrong item",
                "Found a better price elsewhere":"Found a better price elsewhere",
                "Product no longer needed":"Product no longer needed",
                "Changed my mind about the purchase":"Changed my mind about the purchase",
                "Quantity or size was incorrect":"Quantity or size was incorrect",
                "other":"other"
            },
            inputPlaceholder:"Select a reason",
            showCancelButton:true,
            inputValidator:(value)=>{
                if(!value){
                    return "‚ö†Ô∏è Please select a reason before continuing!";
                }
            }
        });

        if(!confirmReason.isConfirmed) return;
        let reason=confirmReason.value;

        if(reason==="other"){
            const customReason = await Swal.fire({
                title:"Please specify your reason",
                input:"textarea",
                inputPlaceholder:"Type your reason here...",
                inputAttributes:{'aria-label':'Cancellation reason'},
                showCancelButton:true,
                inputValidator:(value)=>{
                    if(!value.trim()){
                        return "‚ö†Ô∏è Please enter a reason"
                    }
                }
            })
            if(!customReason.isConfirmed) return;
            reason=customReason.value;
        }

        const formData=new FormData(cancelOrderForm);
        const data=Object.fromEntries(formData.entries());

        const response=await fetch("/user-profile/orders/order-details/cancel-orders",{
            method:'post',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify(data)
        })

        const result=await response.json();
        if(result.success){
            Swal.fire({
                title:"Done",
                text:result.message,
                icon:'success',
                timer:2000
            }).then(()=>{
                location.reload();
            })
        }else{
            Swal.fire("Oops!",result.message,"error")
        }
    })
</script>

<script>
    document.querySelectorAll(".return-form").forEach(form => {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const confirmResult = await Swal.fire({
                title: "Why are you returning this item?",
                input: "select",
                inputOptions: {
                    "Wrong item received": "Wrong item received",
                    "damaged product": "Damaged product",
                    "defective": "Defective",
                    "quality not as expected": "Quality not as expected",
                    "size/fit issue": "Size/fit issue",
                    "changed my mind": "Changed my mind",
                    "other": "Other"
                },
                inputPlaceholder: "Select a reason",
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return "‚ö†Ô∏è Please select a reason before continuing!";
                    }
                }
            });
            if(!confirmResult.isConfirmed) return;

            let reason = confirmResult.value;

            if (reason === "other") {
                const customReason = await Swal.fire({
                    title: "Please specify your reason",
                    input: "textarea",
                    inputPlaceholder: "Type your reason here...",
                    inputAttributes: { 'aria-label': 'Return reason' },
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value.trim()) {
                            return "‚ö†Ô∏è Please enter a reason!";
                        }
                    }
                });

                if (!customReason.isConfirmed) return; // user cancelled
                reason = customReason.value; // use custom input as reason
            }



            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.reason = reason; // either predefined or custom

            const response = await fetch("/user-profile/orders/order-details/return-item", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    title: "Return requested",
                    text: result.message,
                    icon: "success",
                    timer: 2000
                }).then(() => location.reload());
            } else {
                Swal.fire("Oops!", result.message, "error");
            }
        });
    });
    </script>

<%-include ('../../../../views/partials/user/footer')%>
