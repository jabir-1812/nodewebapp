<% if(addresses && addresses.length> 0){ %>
    <div class="row">
        <% addresses.forEach((address,index)=>{ %>
            <div class="col-md-6 mb-3">
                <div class="address-card" id="addressCard<%= index %>">
                    <div class="address-type">
                        <%= address.addressType %>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="addressId" value="<%= address._id %>"
                            <%=index===0 ? 'checked' : '' %>
                        onchange="selectAddress(<%= index %>)">
                            <label class="form-check-label w-100">
                                <strong>
                                    <%= address.name %>
                                </strong><br>
                                <%= address.landMark %>, <%= address.city %><br>
                                        <%= address.state %> - <%= address.pincode %><br>
                                                Phone: +91 <%= address.phone %><br>
                                                    <% if(address.altPhone){ %>
                                                        Alt. Phone: +91 <%= address.altPhone %>
                                                            <% } %>
                            </label>
                    </div>
                    <div class="mt-3">
                        <button class="btn-edit-address" onclick="showEditAddressForm('<%= index %>')">
                            <i class="fas fa-edit me-1"></i> Edit Address
                        </button>
                    </div>

                    <!-- Edit Address Form (Hidden by default) -->
                    <div class="address-form mt-3" id="editAddressFormContainer<%= index %>" style="display: none;">
                        <h5 class="mb-3">Edit Address</h5>
                        <form id="editAddressForm<%= index %>">
                            <input type="hidden" name="addressId" value="<%= address._id %>">

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Address Type</label>
                                    <input type="text" class="form-control" value="<%= address.addressType %>"
                                        name="addressType" required>
                                    <div class="error-message" id="addressType-error<%= index %>"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" class="form-control" value="<%= address.name %>" name="name"
                                        required>
                                    <div class="error-message" id="addressName-error<%= index %>"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" value="<%= address.city %>" name="city"
                                        required>
                                    <div class="error-message" id="addressCity-error<%= index %>"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Landmark</label>
                                    <input type="text" class="form-control" value="<%= address.landMark%>"
                                        name="landMark" required>
                                    <div class="error-message" id="addressLandmark-error<%= index %>"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">State</label>
                                    <input type="text" class="form-control" value="<%= address.state %>" name="state"
                                        required>
                                    <div class="error-message" id="addressState-error<%= index %>"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Pincode</label>
                                    <input type="number" class="form-control" value="<%= address.pincode %>"
                                        name="pincode" required>
                                    <div class="error-message" id="addressPincode-error<%= index %>"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="number" class="form-control" value="<%= address.phone %>" name="phone"
                                        required>
                                    <div class="error-message" id="addressPhone-error<%= index %>"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Alternate Phone</label>
                                    <input type="number" class="form-control" value="<%= address.altPhone %>"
                                        name="altPhone">
                                    <div class="error-message" id="addressAltPhone-error<%= index %>"></div>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Save
                                    Changes</button>
                                <button type="button" class="btn btn-secondary"
                                    onclick="hideEditAddressForm('<%= index %>')">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <% }) %>
    </div>

    <button class="add-address-btn" onclick="showAddAddressForm()">
        <i class="fas fa-plus me-2"></i> Add New Address
    </button>

    <!-- Add New Address Form (Hidden by default) -->
    <div class="address-form" id="addNewAddressFormContainer" style="display: none;">
        <h5 class="mb-3">Add New Address</h5>
        <form id="addAddressForm">
            <input type="hidden" name="userId" value="<%= user._id %>">

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Address Type (Home/Office)</label>
                    <input type="text" class="form-control" name="addressType" required>
                    <div class="error-message" id="addressType-error"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" name="name" required>
                    <div class="error-message" id="addressName-error"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">City</label>
                    <input type="text" class="form-control" name="city" required>
                    <div class="error-message" id="addressCity-error"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Landmark</label>
                    <input type="text" class="form-control" name="landMark" required>
                    <div class="error-message" id="addressLandmark-error"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">State</label>
                    <input type="text" class="form-control" name="state" required>
                    <div class="error-message" id="addressState-error"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Pincode</label>
                    <input type="number" class="form-control" name="pincode" required>
                    <div class="error-message" id="addressPincode-error"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Phone</label>
                    <input type="number" class="form-control" name="phone" required>
                    <div class="error-message" id="addressPhone-error"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Alternate Phone (Optional)</label>
                    <input type="number" class="form-control" name="altPhone">
                    <div class="error-message" id="addressAltPhone-error"></div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save Address</button>
                <button type="button" class="btn btn-secondary" onclick="hideAddAddressForm()">Cancel</button>
            </div>
        </form>
    </div>
    <% }else{ %>
        <div class="text-center py-4">
            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
            <h4>No Address Added</h4>
            <p class="text-muted">Please add an address to continue with your order</p>

            <!-- Add New Address Form (Visible when no addresses) -->
            <div class="address-form mt-4 text-start">
                <h5 class="mb-3">Add New Address</h5>
                <form id="addAddressForm">
                    <input type="hidden" name="userId" value="<%= user._id %>">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Address Type (Home/Office)</label>
                            <input type="text" class="form-control" name="addressType" required>
                            <div class="error-message" id="addressType-error"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="name" required>
                            <div class="error-message" id="addressName-error"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" name="city" required>
                            <div class="error-message" id="addressCity-error"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Landmark</label>
                            <input type="text" class="form-control" name="landMark" required>
                            <div class="error-message" id="addressLandmark-error"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">State</label>
                            <input type="text" class="form-control" name="state" required>
                            <div class="error-message" id="addressState-error"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pincode</label>
                            <input type="number" class="form-control" name="pincode" required>
                            <div class="error-message" id="addressPincode-error"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="number" class="form-control" name="phone" required>
                            <div class="error-message" id="addressPhone-error"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Alternate Phone (Optional)</label>
                            <input type="number" class="form-control" name="altPhone">
                            <div class="error-message" id="addressAltPhone-error"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Address</button>
                </form>
            </div>
        </div>
        <% } %>