<style>
    /* ====================
   CHECKOUT PAGE STYLES
   ==================== */

/* General Container Styling */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Main Layout */
.row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -15px;
}

.col-8, .col-4, .col-1, .col-11, .col-6 {
    padding: 0 15px;
}

.col-8 { width: 66.66%; }
.col-4 { width: 33.33%; }
.col-1 { width: 8.33%; }
.col-11 { width: 91.66%; }
.col-6 { width: 50%; }

/* Border and Spacing */
.border {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.my-5 {
    margin-top: 2rem;
    margin-bottom: 2rem;
}

.my-3 {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
}

.my-2 {
    margin-top: 1rem;
    margin-bottom: 1rem;
}

.p-5 {
    padding: 2rem;
}

/* ====================
   ADDRESS SECTION
   ==================== */

#addressesContainer {
    width: 100%;
    padding: 20px;
}

/* Address Card Styling */
.address-card {
    background-color: #f9f9f9;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.address-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Radio Button Styling */
input[type="radio"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #28a745;
}

/* Address Details */
.address-card .row {
    margin: 8px 0;
    color: #333;
}

/* Form Elements */
.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

/* Labels */
label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
    font-size: 14px;
}

/* Error Messages */
.error-message {
    color: #dc3545;
    font-size: 12px;
    margin-top: 5px;
    display: block;
}

/* ====================
   BUTTONS
   ==================== */

button {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

button[type="submit"],
.btn-primary {
    background-color: #007bff;
    color: white;
}

button[type="submit"]:hover,
.btn-primary:hover {
    background-color: #0056b3;
}

button[type="button"] {
    background-color: #6c757d;
    color: white;
    margin-left: 10px;
}

button[type="button"]:hover {
    background-color: #545b62;
}

.btn-success {
    background-color: #28a745;
    color: white;
    padding: 15px;
    font-size: 16px;
    font-weight: bold;
}

.btn-success:hover {
    background-color: #218838;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

/* Edit/Remove Buttons */
button:not([type]) {
    background-color: #17a2b8;
    color: white;
}

button:not([type]):hover {
    background-color: #138496;
}

/* ====================
   CART ITEMS TABLE
   ==================== */

.table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

.table thead {
    background-color: #f8f9fa;
}

.table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
    vertical-align: middle;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
}

/* Product Image */
.img-thumbnail {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 5px;
}

/* Quantity Controls */
#cartItemsContainer button {
    padding: 5px 12px;
    font-size: 16px;
    font-weight: bold;
    min-width: 35px;
}

input[type="number"] {
    width: 60px;
    text-align: center;
    padding: 5px;
    margin: 0 5px;
    border: 1px solid #ced4da;
    border-radius: 4px;
}

/* Price Styling */
strike {
    color: #999;
}

.text-success {
    color: #28a745;
    font-weight: 500;
}

.text-danger {
    color: #dc3545;
    font-weight: 500;
}

/* ====================
   PAYMENT METHODS
   ==================== */

.container h1 {
    font-size: 24px;
    font-weight: 600;
    padding: 15px;
    margin: 0;
    color: #333;
    text-transform: uppercase;
}

input[name="paymentMethod"] {
    width: 20px;
    height: 20px;
    margin-top: 5px;
}

/* ====================
   COUPON SECTION
   ==================== */

#couponForm input[type="text"] {
    height: 45px;
}

#couponForm button {
    height: 45px;
    width: 100%;
}

.applied-coupon {
    background-color: #d4edda;
    padding: 10px;
    font-weight: 600;
    color: #155724;
}

/* Coupon Messages */
#coupon-error-message,
#coupon-success-message {
    display: block;
    margin-top: 5px;
    font-size: 12px;
}

/* ====================
   PRICE DETAILS
   ==================== */

#priceDetailsContainer .row {
    padding: 15px;
}

#priceDetailsContainer .col-6 {
    font-size: 15px;
    color: #333;
}

.border-bottom {
    border-bottom: 1px solid #e0e0e0;
}

#totalAmount,
#totalPrice {
    font-weight: 700;
    font-size: 18px;
    color: #333;
}

/* ====================
   UTILITY CLASSES
   ==================== */

.text-end {
    text-align: right;
}

.d-flex {
    display: flex;
}

.justify-content-center {
    justify-content: center;
}

.align-items-center {
    align-items: center;
}

.d-grid {
    display: grid;
}

/* ====================
   RESPONSIVE DESIGN
   ==================== */

@media (max-width: 768px) {
    .col-8, .col-4, .col-6 {
        width: 100%;
    }
    
    .table {
        font-size: 12px;
    }
    
    .table th,
    .table td {
        padding: 10px 5px;
    }
    
    button {
        padding: 8px 15px;
        font-size: 12px;
    }
}

/* ====================
   ANIMATIONS
   ==================== */

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.address-form-container,
#addNewAddressFormContainer {
    animation: fadeIn 0.3s ease;
}

/* Hidden Elements */
[style*="display: none"] {
    display: none !important;
}
</style>



<%-include ('../../../views/partials/user/header') %>
    

    <div class="container">
        <div class="row">

            <div class="col-8">
                <!-- addresses -->
                <div class="container border my-5">
                    <div class="row h3">Delivery Address</div>
                    <div class="row">
                        <div id="addressesContainer">
                            <%-include ('../../user/checkout/checkout-partials/4address-forms') %>
                        </div>
                    </div>
                </div>

                <!-- cart items -->
                <div class="container border my-5">
                    <div class="row h3">Cart Items</div>
                    <div class="row">
                        <div id="cartItemsContainer">
                            <%-include ('../../user/checkout/checkout-partials/2cart-items') %>
                        </div>
                    </div>
                </div>

                <div class="container border my-5">
                    <div class="row">
                        <h1 class="h1">payment methods</h1>
                    </div>

                    <div class="row border-bottom my-2 py-2">
                        <div class="col-1">
                            <input type="radio" name="paymentMethod" id="COD" value="COD" required>
                        </div>
                        <div class="col-11">
                            <label for="COD">Cash On Delivery</label>
                        </div>
                    </div>

                    <div class="row border-bottom my-2 py-2">
                        <div class="col-1">
                            <input type="radio" name="paymentMethod" id="onlinePayment" value="onlinePayment" required>
                        </div>
                        <div class="col-11">
                            <label for="onlinePayment">Cards/Netbanking/Wallet</label>
                        </div>
                    </div>                    
                    
                    <div class="row border-bottom my-2 py-2">
                        <div class="col-1">
                            <input type="radio" name="paymentMethod" id="walletPayment" value="walletPayment" required>
                        </div>
                        <div class="col-11">
                            <label for="walletPayment">TeeSpace Wallet</label>
                            <div>(Avaiable Balance: Rs.<%= userWallet.balance %>/-)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- right side of the checkout page -->
            <div class="col-4">
                <!-- coupon form -->
                <div class="container border my-5" id="couponContainer">
                    <%- include('../../user/checkout/checkout-partials/coupon-forms.ejs')%>
                </div>

                <!-- price details -->
                <div class="container border my-5">
                    <div class="row">
                        <h1 class="h1">Price Details</h1>
                    </div>
                    <div id="priceDetailsContainer">
                        <%-include ('../../user/checkout/checkout-partials/price details.ejs') %>
                    </div>
                </div>
            </div>
        </div>
    </div>



<%-include ('../../../views/partials/user/footer') %>

<!--when loading this page for the first time, if there any cart updation, it will work -->
 <script>
    const isCartUpdated='<%= isCartUpdated %>';
    if(isCartUpdated===true){
        Swal.fire({
            title:"Cart quantity is decreased",
            text:"Some products are only few left",
            timer:5000,
            showConfirmButton:true,
            icon:"warning"
        })
    }
 </script>


<!-- address script -->
<script>
// Show/hide the "add new address" form
    function showAddAddressForm() {
        document.getElementById("addNewAddressFormContainer").style.display = "block";
    }

    function hideAddAddressForm() {
        document.getElementById("addNewAddressFormContainer").style.display = "none";
        // optionally clear form fields
        const form = document.getElementById("addAddressForm");
        if (form) form.reset();
    }

    // Event delegation for ALL forms inside addressesContainer
    document.getElementById("addressesContainer").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const form = e.target;

        // --- Add New Address Form ---
        if (form.id === "addAddressForm") {
            clearErrorMessages();
            const formData = Object.fromEntries(new FormData(form));
            const { addressType, name, city, landMark, state, pincode, phone, altPhone } = formData;

            let isValid = true;
            const namePattern = /^[A-Za-z\s]+$/;
            const pincodePattern = /^\d{6}$/;
            const phonePattern = /^\d{10}$/;

            if (!namePattern.test(addressType)) {
                document.getElementById('addressType-error').innerHTML = "should contain alphabets only.";
                isValid = false;
            }
            if (!namePattern.test(name)) {
                document.getElementById('addressName-error').innerHTML = "Name should contain alphabets only.";
                isValid = false;
            }
            if (!namePattern.test(city)) {
                document.getElementById('addressCity-error').innerHTML = "should contain alphabets only.";
                isValid = false;
            }
            if (!namePattern.test(landMark)) {
                document.getElementById('addressLandmark-error').innerHTML = "should contain alphabets only.";
                isValid = false;
            }
            if (!namePattern.test(state)) {
                document.getElementById('addressState-error').innerHTML = "should contain alphabets only.";
                isValid = false;
            }
            if (!pincodePattern.test(pincode)) {
                document.getElementById('addressPincode-error').innerHTML = "Pincode should be a 6-digit number.";
                isValid = false;
            }
            if (!phonePattern.test(phone)) {
                document.getElementById('addressPhone-error').innerHTML = "Phone number should be a 10-digit number.";
                isValid = false;
            }
            if (!phonePattern.test(altPhone)) {
                document.getElementById('addressAltPhone-error').innerHTML = "Alternate phone number should be a 10-digit number.";
                isValid = false;
            }
            if (phone === altPhone) {
                document.getElementById('addressAltPhone-error').innerHTML = "Phone number and alternate phone number should be different.";
                isValid = false;
            }

            if (!isValid) return;

            const response = await fetch('/add-address-in-checkout', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                let html = await response.text();
                document.getElementById('addressesContainer').innerHTML = html;
            }else{
                const result=await response.json()
                Swal.fire(result.message,"","error")
            }
        }

        // --- Edit Address Form ---
        if (form.id.startsWith("editAddressForm")) {
            const index = form.id.replace("editAddressForm", "");
            // every edit-form has id like:
            // editAddressForm0
            // editAddressForm1
            // editAddressForm2
            // so the replace() replace the "editAddressForm" with "" (empty string)
            // the result will be "1".
            //eg:
            // "editAddressForm0".replace("editAddressForm", "");
            // result → "0"
            // "editAddressForm12".replace("editAddressForm", "");
            // result → "12"

            //we need form's index number to show the error message for that specific form, thats why we using replace()
            // if we don't have the index number, it may always show the error message in the first form.
            clearErrorMessages();

            const formData = Object.fromEntries(new FormData(form));
            const { addressType, name, city, landMark, state, pincode, phone, altPhone } = formData;

            let isValid = true;
            const namePattern = /^[A-Za-z\s]+$/;
            const pincodePattern = /^\d{6}$/;
            const phonePattern = /^\d{10}$/;

            if (!namePattern.test(addressType)) {
                document.getElementById('addressType-error' + index).innerHTML = "should contain alphabets only.";
                isValid = false;
            }
            if (!namePattern.test(name)) {
                document.getElementById('addressName-error' + index).innerHTML = "Name should contain alphabets only.";
                isValid = false;
            }
            if (!namePattern.test(city)) {
                document.getElementById('addressCity-error' + index).innerHTML = "should contain alphabets only.";
                isValid = false;
            }
            if (!namePattern.test(landMark)) {
                document.getElementById('addressLandmark-error' + index).innerHTML = "should contain alphabets only.";
                isValid = false;
            }
            if (!namePattern.test(state)) {
                document.getElementById('addressState-error' + index).innerHTML = "should contain alphabets only.";
                isValid = false;
            }
            if (!pincodePattern.test(pincode)) {
                document.getElementById('addressPincode-error' + index).innerHTML = "Pincode should be a 6-digit number.";
                isValid = false;
            }
            if (!phonePattern.test(phone)) {
                document.getElementById('addressPhone-error' + index).innerHTML = "Phone number should be a 10-digit number.";
                isValid = false;
            }
            if (!phonePattern.test(altPhone)) {
                document.getElementById('addressAltPhone-error' + index).innerHTML = "Alternate phone number should be a 10-digit number.";
                isValid = false;
            }
            if (phone === altPhone) {
                document.getElementById('addressAltPhone-error' + index).innerHTML = "Phone number and alternate phone number should be different.";
                isValid = false;
            }

            if (!isValid) return;

            const response = await fetch('/edit-address-in-checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                let html = await response.text();
                document.getElementById('addressesContainer').innerHTML = html;
            }else{
                const result=await response.json()
                Swal.fire(result.message,"","error")
            }
        }
    });

    function clearErrorMessages() {
        const errorElements = document.getElementsByClassName('error-message');
        Array.from(errorElements).forEach(el => el.innerHTML = "");
    }

    // Keep show/hide logic for Edit button
    function showEditAddressForm(index) {
        const container = document.getElementById(`editAddressFormContainer${index}`);
        const btn = document.getElementById(`editFormBtn${index}`);

        if (container.style.display === 'block') {
            container.style.display = 'none';
            btn.innerHTML = "Edit";
        } else {
            container.style.display = 'block';
            btn.innerHTML = "Cancel";
        }
    }
</script>


<!-- cart items script -->
<script>
    async function changeQuantity(productId,count){
        document.getElementById(`outOfStockMessage${productId}`).innerHTML="";

        const currentQtyElement=document.getElementById(`cartProductQuantity${productId}`);
        let currentQty=currentQtyElement.value;
        
        if(parseInt(currentQty)+count > 3){
            return Swal.fire({
                title:"Maximum limit is 3",
                icon:'warning',
                timer:3000
            })
        }
        if(parseInt(currentQty)+count <1 || parseInt(currentQty)+count <0){
            return;
        }

        const response=await fetch('/checkout/change-cart-quantity',{
            method:'post',
            headers:{
                'Content-Type':'application/json',
            },
            body:JSON.stringify({
                productId:productId,
                count:count
            })
        })

        const data=await response.json()

        if(data.success){
            if(data.success && data.reload){
                Swal.fire({
                    title:data.message,
                    icon:"success",
                    timer:5000,
                    showConfirmButton:true
                }).then(()=>{
                    location.reload();
                })
            }
            if(data.success && !data.reload){
                Swal.fire({
                    title:data.message,
                    icon:"success",
                    timer:5000,
                    showConfirmButton:true
                })
            }
        }else{
            if(data.message && data.reload){
                Swal.fire({
                    title:data.message,
                    icon:"error",
                    timer:5000,
                    showConfirmButton:true
                }).then(()=>{
                    location.reload();
                })
            }
            if(data.message && !data.reload){
                Swal.fire({
                    title:data.message,
                    icon:"error",
                    timer:5000,
                    showConfirmButton:true
                })
            }
        }
    }     

    async function removeItem(productId) {
        Swal.fire({
            title: 'Are you sure?',
            text: "This item will be removed from your cart",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/checkout/delete-cart-item/${productId}`, {
                    method: 'DELETE'
                })
                .then(res => {
                    if (res.ok) {
                        Swal.fire({
                            title: 'Removed!',
                            text: 'Item has been removed from your cart.',
                            icon: 'success',
                            timer: 2000
                        }).then(() => {
                            window.location.reload();
                        });
                    }
                });
            }
        })
    }
</script>


<!-- coupon script -->
<script>
    document.getElementById('couponContainer').addEventListener('submit',async (e)=>{
       try {
         e.preventDefault();
         if(Number('<%= totalPrice %>')===0){
            return Swal.fire({
                title:"Add products to the cart",
                icon:"warning",
                timer:5000,
                showConfirmButton:true
            })
         }

        const couponForm=e.target;
        
        const couponCode=document.getElementById('couponCode').value.toUpperCase();
        const couponCodeError=document.getElementById('coupon-error-message')
        const couponCodeSuccess=document.getElementById('coupon-success-message')

        couponCodeError.innerHTML="";
        couponCodeSuccess.innerHTML="";


        if(!couponCode || couponCode.trim()==="" || couponCode.length<4){
            couponCodeError.innerHTML="Enter a valid coupon code";
            return;
        }

        const response=await fetch('/checkout/apply-coupon',{
            method:"POST",
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify({couponCode})
        })

        const data=await response.json();
        console.log("data=======",data)
        console.log("userCart==========",data.userCart)

        if(data.success){
            if(data.html?.cartItems){
                document.getElementById('cartItemsContainer').innerHTML=data.html.cartItems;
            }
            if(data.html?.priceDetails){
                document.getElementById('priceDetailsContainer').innerHTML=data.html.priceDetails;
            }
            if(data.html?.couponForm){
                document.getElementById('couponContainer').innerHTML=data.html.couponForm;
            }
            if(data.html?.totalAmount){
                document.getElementById('totalAmountContainer').innerHTML=data.html.totalAmount;
            }
            const couponCodeSuccess=document.getElementById('coupon-success-message')
            couponCodeSuccess.innerHTML=data.message;
            

            if(data.reload){
                Swal.fire({
                    text:data.message,
                    icon:"error",
                    timer:5000,
                    showConfirmButton:true
                }).then(()=>{
                    location.reload();
                })
            }
        }else{
            if(data.html){
                //if any error, re-render the: cart, coupon, price details sections.
                document.getElementById('cartItemsContainer').innerHTML=data.html.cartItems;
                document.getElementById('priceDetailsContainer').innerHTML=data.html.priceDetails;
                document.getElementById('couponContainer').innerHTML=data.html.couponForm;
                Swal.fire({
                    title:data.message,
                    text:data.text || "",
                    icon:"error"
                });
            }else if(data.message){
                couponCodeError.innerHTML=data.message;
            }
            if(data.reload){
                Swal.fire({
                    title:data.message,
                    text:data.text || "",
                    icon:"error",
                    timer:5000,
                    showConfirmButton:true
                }).then(()=>{
                    location.reload();
                })
            }
        }
       } catch (error) {
        console.error("coupon script error:",error)
       }
    })

    async function  removeCoupon(couponCode,couponId) {
        try {
            console.log("couponCode",couponCode)
            console.log("couponId",couponId)

            const response=await fetch('/checkout/remove-coupon',{
                method:"DELETE",
                headers:{
                    'Content-Type':'application/json'
                },
                body:JSON.stringify({couponCode:couponCode,couponId:couponId})
            })

            const data=await response.json();
            if(data.success){
                Swal.fire({
                    title:data.message,
                    icon:'success',
                    timer:5000,
                    showConfirmButton:true
                }).then(()=>{
                    location.reload()
                })
            }else{
                Swal.fire({
                    title:data.message,
                    icon:'error',
                    timer:5000,
                    showConfirmButton:true
                }).then(()=>{
                    location.reload()
                })
            }
        } catch (error) {
            console.error("removeCoupon() error:",error)
        }
    }
</script>


<!-- order placement script -->
 <script>
    
 </script>

