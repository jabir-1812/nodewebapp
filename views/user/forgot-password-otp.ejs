<link rel="stylesheet" href="/user/forgot-password-otp.css">

<div class="verification-container">
  <div class="verification-card">
    <h2 class="verification-title">Email Verification</h2>
    <p class="verification-subtitle">We've sent a 6-digit code to your email</p>

    <form class="verification-form" onsubmit="return validateOtpForm()">
      <div class="form-group">
        <label for="otp" class="form-label">Enter OTP</label>
        <input 
          type="text" 
          name="otp" 
          id="otp" 
          class="otp-input"
          placeholder="••••••"
          maxlength="6"
          pattern="\d{6}"
          required
          inputmode="numeric"
        >
      </div>

      <button type="submit" class="verify-btn">
        Verify OTP
        <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 5L19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </form>

    <div class="resend-container">
      <button type="button" class="resend-btn" id="resendBtn" disabled>
        <svg class="resend-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C15.1846 2 18.022 3.55371 19.755 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M22 6V2H18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M17 7L22 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span id="resendText">Resend OTP</span>
        <span id="countdown"> (1:00)</span>
      </button>
    </div>

    <% if(locals.message && message.length > 0) { %>
      <div class="error-message">
        <svg class="error-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M12 8V12V8ZM12 16H12.01H12ZM12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <%= message %>
      </div>
    <% } %>

    <div class="login-redirect">
      Already verified? <a href="/login" class="login-link">Login now</a>
    </div>
  </div>
</div>
<!-- <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->

<script>
document.addEventListener('DOMContentLoaded', function() {
  const resendBtn = document.getElementById('resendBtn');
  const resendText = document.getElementById('resendText');
  const countdownEl = document.getElementById('countdown');
  let timeLeft = 60;
  
  // Start countdown
  const countdown = setInterval(() => {
    timeLeft--;
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    countdownEl.textContent = ` (${minutes}:${seconds < 10 ? '0' : ''}${seconds})`;
    
    if (timeLeft <= 0) {
      clearInterval(countdown);
      resendBtn.disabled = false;
      countdownEl.textContent = '';
      resendText.textContent = 'Resend OTP';
      resendBtn.style.opacity = '1';
    }
  }, 1000);

  // Resend OTP functionality
  resendBtn.addEventListener('click', function() {
    $.ajax({
      type:'post',
      url:'/resend-forgot-otp',
      success:function(response){
        if(response.success){
          Swal.fire({
            icon:'success',
            title:'Resend OTP Successful',
            showConfirmButton:false,
            timer:1500
          })
        }else{
          Swal.fire({
            icon:'error',
            title:'Error',
            text:'Failed to resend OTP. Please try again'
          })
        }
      },
      error:function(){
        Swal.fire({
          icon:'error',
          title:"Error",
          text:"Failed to resend OTP. Please try again"
        })
      }
    })
    // Here you would typically make an API call to resend the OTP
    console.log('OTP resend requested');
    
    // Reset the timer
    timeLeft = 60;
    resendBtn.disabled = true;
    resendBtn.style.opacity = '0.7';
    resendText.textContent = 'Resend OTP';
    countdownEl.textContent = ` (1:00)`;
    
    const newCountdown = setInterval(() => {
      timeLeft--;
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      countdownEl.textContent = ` (${minutes}:${seconds < 10 ? '0' : ''}${seconds})`;
      
      if (timeLeft <= 0) {
        clearInterval(newCountdown);
        resendBtn.disabled = false;
        countdownEl.textContent = '';
        resendText.textContent = 'Resend OTP';
        resendBtn.style.opacity = '1';
      }
    }, 1000);
  });
});
</script>

<script>

  function validateOtpForm(){
    console.log('validate Form has started')
    const otpInput =document.getElementById('otp').value;
    $.ajax({
      type:'POST',
      url:'/verify-password-forgot-otp',
      data:{otp:otpInput},
      success:function(response){
        if(response.success){
          Swal.fire({
            icon:'success',
            title:"OTP verified successfully",
            showConfirmButton:false,
            timer:1500
          }).then(()=>{
            window.location.href=response.redirectUrl;
          })
        }else{
          Swal.fire({
            icon:'error',
            title:"Invalid OTP",
            text:response.message
          })
        }
      },
      error:function(){
        Swal.fire({
          icon:'error',
          title:'Error',
          text:'Failed to verify OTP, Please try again.'
        })
      }
    });
    return false;
  }

</script>
<%- include("../../views/partials/user/footer") %>





