<style>
  /* General Styles */
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background-color: #f5f5f5;
  color: #333;
}

.main {
  padding: 50px 0;
}

/* Breadcrumbs */
.breadcrumb-wrap {
  background-color: #fff;
  padding: 20px 0;
  border-bottom: 1px solid #eee;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #777;
}

.breadcrumb a {
  text-decoration: none;
  color: #555;
  transition: color 0.3s ease;
}

.breadcrumb a:hover {
  color: #088178;
}

/* Shopping Cart Table */
.shopping-summery {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background-color: #fff;
  border: 1px solid #ddd;
}

.shopping-summery th, .shopping-summery td {
  padding: 15px;
  border-bottom: 1px solid #eee;
  text-align: center;
}

.shopping-summery th {
  background-color: #f8f8f8;
  font-weight: bold;
}

.shopping-summery tbody tr:hover {
  background-color: #f9f9f9;
}

.product-thumbnail img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
}

.product-name a {
  text-decoration: none;
  color: #333;
  font-weight: 600;
}

.quantity-control {
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #ddd;
  border-radius: 5px;
}

.quantity-control button {
  background: none;
  border: none;
  padding: 8px 12px;
  cursor: pointer;
  color: #088178;
  font-weight: bold;
}

.quantity-input {
  width: 40px;
  text-align: center;
  border: none;
  background-color: transparent;
  pointer-events: none;
}

.action a {
  color: #dc3545;
  text-decoration: none;
  font-weight: 500;
}

/* Price Details Sidebar */
.cart-totals {
  background-color: #fff;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

.heading_s1 h4 {
  border-bottom: 2px solid #088178;
  padding-bottom: 10px;
  margin-bottom: 20px;
  font-size: 1.25rem;
}

.cart-totals table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.cart-totals td {
  padding: 10px 0;
}

.cart_total_label {
  font-weight: 500;
}

.cart_total_amount .text-brand {
  color: #088178;
  font-size: 1.5rem;
  font-weight: 900;
}

.btn {
  display: block;
  width: 100%;
  padding: 15px;
  text-align: center;
  background-color: #088178;
  color: #fff;
  text-decoration: none;
  border-radius: 5px;
  font-weight: bold;
  transition: background-color 0.3s ease;
}

.btn:hover {
  background-color: #066d62;
}
</style>

<%- include("../../views/partials/user/header") %>
  <main class="main">
    <div class="page-header breadcrumb-wrap">
      <div class="container">
        <div class="breadcrumb">
          <a href="/" rel="nofollow">Home </a>
          <span>></span> Your Cart
        </div>
      </div>
    </div>
    <section class="mt-50 mb-50">
      <div class="container">
        <div class="row">
          <div class="col-9">
            <div class="table-responsive">
              <table class="table shopping-summery text-center clean">
                <thead>
                  <tr class="main-heading">
                    <th scope="col">Image</th>
                    <th scope="col">Name</th>
                    <th scope="col">Price</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Remove</th>
                  </tr>
                </thead>
                <tbody>

                  <% if (userCart.items.length> 0) { %>
                    <% var x=0 %>
                      <% for (let i=0; i < userCart.items.length;i++) { %>

                        <tr>

                          <td class="image product-thumbnail">
                            <a href="/product-details?id=<%= userCart.items[i].productId._id %>">
                              <img style="width: 40%;"
                                src="/uploads/resized-images/<%= userCart.items[i].productId.productImage[0] %>" alt="#" />
                            </a>

                          </td>
                          <td class="product-des product-name">
                            <h5 class="product-name">
                              <a href="/product-details?id=<%= userCart.items[i].productId._id %>">
                                <%= userCart.items[i].productId.productName %>
                              </a>
                            </h5>
                            <p class="font-xs">
                              <%= userCart.items[i].productId.category?.name %><br />
                                <%= userCart.items[i].productId.brand?.brandName %>
                            </p>
                          </td>
                          <td class="price" data-title="Price">‚Çπ
                              <text id="subTotal<%= userCart.items[i].productId._id %>">
                                <%= userCart.items[i].productId.salePrice * userCart.items[i].quantity %>
                                <!-- <strike><%= userCart.items[i].productId.regularPrice * userCart.items[i].quantity %></strike> -->
                              </text><br>
                              
                              <small class="text-muted text-nowrap">
                                ‚Çπ<span id="price">
                                  <%= userCart.items[i].productId.salePrice %>
                                  ‚Çπ<strike><%= userCart.items[i].productId.regularPrice %></strike>
                                </span>/ per item 
                              </small>
                          </td>

                            <td class="text-center" data-title="Stock">
                              <div class="detail-qty border radius m-auto">
                                <div class="quantity-control">


                                <% if(userCart.items[i].productId.quantity !==0 ){ %>
                                  <button class="btn btn-sm increment-button"
                                    onclick="changeQuantity(
                                      '<%= userCart.items[i].productId._id %>', 
                                      '<%= userCart.items[i].quantity %>',
                                       1, 
                                      '<%= userCart.items[i].productId.salePrice %>',  
                                      '<%= userCart.items[i].productId._id %>', 
                                      '<%= userCart.items[i].productId.quantity%>')">+</button>


                                  <input class="quantity-input" id="cartProductQuantity<%= userCart.items[i].productId._id %>"
                                    value="<%=userCart.items[i].quantity %>" style="width: 45px;" type="text" readonly value="">
                                  <button class="btn btn-sm decrement-button"
                                    onclick="changeQuantity(
                                      '<%= userCart.items[i].productId._id %>',
                                       '<%= userCart.items[i].quantity %>',
                                        -1, 
                                        '<%= userCart.items[i].productId.salePrice %>',  
                                        '<%= userCart.items[i].productId._id %>', 
                                        '<%= userCart.items[i].productId.quantity%>')">-</button>
                                    <% }else{ %>
                                    <h5 class="text-danger">Out Of Stock</h5>
                                    <% } %>

                                </div>
                              </div>
                            </td>

                            <td class="action" data-title="Remove">
                              <a class="btn btn-sm" href="#"
                                onclick="confirmRemove('<%= userCart.items[i].productId._id %>')">
                                <i class="fi-rs-trash"></i>üóëÔ∏èRemove
                              </a>
                            </td>

                            <% } %>

                              <% } else { %>
                        <tr>

                          <td colspan="2" class="text-center">
                            <p class="lead mb-4">No item found in Cart</p>
                          </td>
                        </tr>
                        <% } %>

                </tbody>
              </table>
            </div>
          </div>
          <div class="col-3">
            <div class="border p-md-4 p-30 border-radius cart-totals">
              <div class="heading_s1 mb-3">
                <h4>PRICE DETAILS</h4>
              </div>
              <div class="table-responsive">
                <table class="table">
                  <tbody>

                    <tr>
                      <td class="cart_total_label">Shipping</td>
                      <td class="cart_total_amount"> <i class="ti-gift mr-5"></i> Free Shipping
                      </td>
                    </tr>
                    <tr>
                      <td class="cart_total_label">Total</td>
                      <td class="cart_total_amount"><span class="font-lg fw-900 text-brand">‚Çπ
                          <text id="total">
                            <%= grandTotal %>
                          </text>
                        </span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <a href="/checkout" class="btn "> <i class="fi-rs-box-alt mr-10"></i>
                Proceed To CheckOut</a>
            </div>
          </div>

        </div>

      </div>
      </div>
      </div>
      </div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->

  <script>
    function changeQuantity(productId, cartQuantity, count, productPrice, i, productQuantity) {
      const cartProductQuantityElement = document.querySelector(`#cartProductQuantity${i}`)
      const subtotalElement = document.querySelector(`#subTotal${i}`);
      const totalElements = document.getElementById('total').innerHTML;

      let currentQuantity = parseInt(cartProductQuantityElement.value)
      const currentSubTotal = parseInt(subtotalElement.innerHTML);

      if (currentQuantity + count > 3) {
        Swal.fire({
          title: 'Limit Exceeded!',
          text: 'You can only add up to 3 items to your cart.',
          icon: 'error',
          timer: 5000
        });
        return;
      }

      const newQuantity = currentQuantity + count

      if (count === -1 && newQuantity < 1) {
        return;
      }

      if (count == 1 && newQuantity > productQuantity) {
        Swal.fire({
          title: 'STOCK!',
          text: 'Product is out of stock.',
          icon: 'error',
          timer: 5000
        })
        return
      }

      const newSubtotal = newQuantity * productPrice
      if (count == 1) {
        document.getElementById(`subTotal${i}`).innerHTML = parseInt(subtotalElement.innerHTML) + parseInt(productPrice)
      } else {
        document.getElementById(`subTotal${i}`).innerHTML = parseInt(subtotalElement.innerHTML) - parseInt(productPrice)
      }
      fetch('/change-cart-quantity',{
        method:'post',
        headers:{
          "Content-Type":"application/json"
        },
        body:JSON.stringify({
          productId:productId,
          quantity:newQuantity,
          count:count
        })
      })
      .then(res=>res.json())
      .then(response=>{
          let currentQuantity = parseInt(cartProductQuantityElement.value)
          let currentSubTotal = parseInt(subtotalElement.innerHTML)

          document.getElementById(`cartProductQuantity${i}`).value = currentQuantity + count
          // document.getElementById(`subTotal${i}`).innerHTML = currentSubTotal * count;
          document.getElementById(`subTotal${i}`).innerHTML = newSubtotal;

          if (response.count == 1) {
            document.getElementById(`total`).innerHTML = parseInt(response.grandTotal)
          } else {
            document.getElementById(`total`).innerHTML = parseInt(response.grandTotal)
          }
      })
      .catch(error=>{
        console.log("changeQuantity() error, error in catch block after fetching to the /change-quantity route")
      })
    
    }

    function confirmRemove(productId) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it!'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/delete-cart-item?id=${productId}`;
        }
      })
    }
  </script>
  <%- include("../../views/partials/user/footer") %>