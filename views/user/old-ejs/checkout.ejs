<style>
    .error-message{
        color: red;
        font-size: smaller;
    }
</style>

<%-include ('../../views/partials/user/header') %>

    <h1 style="text-align: center;">Checkout</h1>

    <section class="mt-50 mb-50">
        <div class="container">

            <!-- addresses -->
            <div class="row">

                <h3>Delivery Address</h3>
                
                
                    <% addresses.forEach(function(address, index) { %>
                        <div>
                            <input type="radio" name="addressId" value="<%= address._id %>" <%=index===0 ? 'checked' : '' %> >
                            <div id="addressData<%= index %>">
                                <%= address.addressType %> - <strong><%= address.name %></strong>- 
                                <%= address.city %> - 
                                <%= address.landMark %> - <%= address.state %> - 
                                <%= address.pincode %> - +91 <%= address.phone %> - 
                                +91<%= address.altPhone %>
                            </div>
                            <button id="editFormBtn<%= index %>" type="button" onclick="showEditAddressForm('<%= index %>')">Edit Address</button>
                            
                            <div id="editAddressFormContainer<%= index %>"  style="display: none;">
                                
                                <form action="" id="editAddressForm<%= index %>">
                                    <!-- hidden input to store address _id -->
                                    <input type="hidden" name="addressId" id="addressId" value="<%= address._id %>">
                                    
                                    <div class="row mb-50">
                                        <div class="form-group col-md-4">
                                            <label for="addressType">Address Type:</label>
                                            <input type="text" class="form-control border-3" value="<%= address.addressType %>" id="addressType" name="addressType" required>
                                            <div id="addressType-error<%= index %>" class="error-message"></div>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="name">Name:</label>
                                            <input type="text" class="form-control border-3" value="<%= address.name %>" id="name" name="name" required>
                                            <div id="addressName-error<%= index %>" class="error-message"></div>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="city">City:</label>
                                            <input type="text" class="form-control border-3" id="city" value="<%= address.city %>" name="city" required>
                                            <div id="addressCity-error<%= index %>" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="form-group col-md-4">
                                            <label for="landMark">Landmark:</label>
                                            <input type="text" class="form-control border-3" value="<%= address.landMark%>" id="landMark" name="landMark" required>
                                            <div id="addressLandmark-error<%= index %>" class="error-message"></div>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="state">State:</label>
                                            <input type="text" class="form-control border-3" value="<%= address.state %>" id="state" name="state" required>
                                            <div id="addressState-error<%= index %>" class="error-message"></div>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="pincode">Pincode:</label>
                                            <input type="number" class="form-control border-3" value="<%= address.pincode %>" id="pincode" name="pincode" required>
                                            <div id="addressPincode-error<%= index %>" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="form-group col-md-4">
                                            <label for="phone">Phone:</label>
                                            <input type="number" class="form-control border-3" id="phone" value="<%= address.phone %>" name="phone" required>
                                            <div id="addressPhone-error<%= index %>" class="error-message"></div>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="altPhone">Alternate Phone:</label>
                                            <input type="number" class="form-control border-3" id="altPhone" value="<%= address.altPhone %>" name="altPhone" required>
                                            <div id="addressAltPhone-error<%= index %>" class="error-message"></div>
                                        </div>
                                    </div>
                                    <button type="submit" id="submitButton" class="btn btn-primary">Submit</button>
                                </form>
                            </div>

                            <script>

                                function showEditAddressForm(index){
                                    const editAddressFormContainer=document.getElementById(`editAddressFormContainer${index}`);
                                    const editFormBtn=document.getElementById(`editFormBtn${index}`)

                                    if(editAddressFormContainer.style.display==='block'){
                                        editAddressFormContainer.style.display='none';
                                        editFormBtn.innerText="Edit Address"
                                    }else{
                                        editAddressFormContainer.style.display='block';
                                        editFormBtn.innerText="Cancel Edit Address"
                                    }
                                    

                                    const editAddressForm=document.getElementById(`editAddressForm${index}`);
                                    editAddressForm.addEventListener('submit',async (e)=>{
                                        e.preventDefault();
                                        clearErrorMessages();
                                        // console.log("form submission prevented")
                                        let isValid=true;
                                        const addressId=editAddressForm.querySelector('[name="addressId"]').value;
                                        const addressType = editAddressForm.querySelector('[name="addressType"]').value;
                                        const name = editAddressForm.querySelector('[name="name"]').value;
                                        const city = editAddressForm.querySelector('[name="city"]').value;
                                        const landMark = editAddressForm.querySelector('[name="landMark"]').value;
                                        const state = editAddressForm.querySelector('[name="state"]').value;
                                        const pincode = editAddressForm.querySelector('[name="pincode"]').value;
                                        const phone = editAddressForm.querySelector('[name="phone"]').value;
                                        const altPhone = editAddressForm.querySelector('[name="altPhone"]').value;
                                        const namePattern = /^[A-Za-z\s]+$/;
                                        const pincodePattern = /^\d{6}$/;
                                        const phonePattern = /^\d{10}$/;

                                        if (!namePattern.test(addressType)) {
                                            document.getElementById('addressType-error'+index).innerHTML="should contain alphabets only.";
                                            isValid=false;
                                        }
                                        if (!namePattern.test(name)) {
                                            document.getElementById('addressName-error'+index).innerHTML="Name should contain alphabets only.";
                                            isValid=false;
                                        }
                                        if (!namePattern.test(city)) {
                                            document.getElementById('addressCity-error'+index).innerHTML="should contain alphabets only.";
                                            isValid=false;
                                        }
                                        if (!namePattern.test(landMark)) {
                                            document.getElementById('addressLandmark-error'+index).innerHTML="should contain alphabets only.";
                                            isValid=false;
                                        }
                                        if (!namePattern.test(state)) {
                                            document.getElementById('addressState-error'+index).innerHTML="should contain alphabets only.";
                                            isValid=false;
                                        }
                                        if (!pincodePattern.test(pincode)) {
                                            document.getElementById('addressPincode-error'+index).innerHTML="Pincode should be a 6-digit number.";
                                            isValid=false;
                                        }
                                        if (!phonePattern.test(phone)) {
                                            document.getElementById('addressPhone-error'+index).innerHTML="Phone number should be a 10-digit number.";
                                            isValid=false;
                                        }
                                        if (!phonePattern.test(altPhone)) {         
                                            document.getElementById('addressAltPhone-error'+index).innerHTML="Alternate phone number should be a 10-digit number.";
                                            isValid=false;
                                        }
                                        if (phone === altPhone) {
                                            document.getElementById('addressAltPhone-error'+index).innerHTML="Phone number and alternate phone number should be different.";
                                            isValid=false;
                                        }
                                        if(isValid){
                                            console.log("form submission done")
                                            try {
                                                const formData={
                                                    addressId,
                                                    addressType,
                                                    name,
                                                    city,
                                                    landMark,
                                                    state,
                                                    pincode,
                                                    phone,
                                                    altPhone
                                                }
                                                const response= await fetch('/edit-address-in-checkout',{
                                                    method:'post',
                                                    headers:{
                                                        'Content-Type':'application/json'
                                                    },
                                                    body:JSON.stringify(formData)
                                                })

                                                const responseJson=await response.json();
                                                if(responseJson.success){
                                                    document.getElementById(`addressData${index}`).innerHTML=`
                                                        ${responseJson.address.addressType} - <strong>${responseJson.address.name}</strong>
                                                        ${responseJson.address.city} - ${responseJson.address.landMark} -
                                                        ${responseJson.address.state} - ${responseJson.address.pincode} -
                                                        ${responseJson.address.phone} - ${responseJson.address.altPhone}`;

                                                    editAddressFormContainer.style.display='none';
                                                    editFormBtn.innerText="Edit Address"
                                                }
                                            } catch (error) {
                                                console.log('something went wrong')
                                            }
                                            
                                            
                                        }
                                    })
                                }

                                function clearErrorMessages() {
                                    console.log('clearErrorMessage() has started')
                                    const errorElements = document.getElementsByClassName('error-message');
                                    // console.log("error elements:",errorElements)
                                    Array.from(errorElements).forEach(element => {
                                        // console.log("before:::::",element);
                                        element.innerHTML = "";
                                        // console.log("after:::::",element)
                                    });
                                }


                            </script>
                        </div>
                        <% }) %>

                    <div>
                        <button type="button" onclick="showAddAddressForm()">Add new address</button>
                        <% if (addresses && addresses.length>0 ){ %>
                        <div id="addAddressFormContainer" style="display:none;">
                            <% }else{ %>
                                <div id="addAddressFormContainer" style="display:block;"></div>
                                <%}%>
                            <form id="addAddressForm">
                                <input type="hidden" name="userId" value="<%= user._id %>">

                                <input type="text" name="addressType" placeholder="Address Type" required>
                                <input type="text" name="name" placeholder="Name" required>
                                <input type="text" name="city" placeholder="City" required>
                                <input type="text" name="landMark" placeholder="Landmark" required>
                                <input type="text" name="state" placeholder="State" required>
                                <input type="number" name="pincode" placeholder="Pincode" required>
                                <input type="number" name="phone" placeholder="Phone" required>
                                <input type="number" name="altPhone" placeholder="Alternate Phone" required>

                                <button type="submit">Save</button>
                            </form>
                        </div>
                        <script>
                            function showAddAddressForm() {
                                document.getElementById("addAddressFormContainer").style.display = "block";
                            }

                            document.getElementById("addAddressForm").addEventListener("submit", async (e) => {
                                e.preventDefault();
                                
                                const formData = Object.fromEntries(new FormData(e.target));
                                
                                const response = await fetch('/add-address-in-checkout', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify(formData)
                                });
                                
                                const result = await response.json();
                                if (result.success) {
                                    location.reload(); // Refresh checkout page to show new address
                                }
                            });
                            </script>

                </div>

            </div>

            <div class="row">
                <div class="col-12">
                    <div class="col-9">
                        <h3>Order Summary</h3>
                        <div class="table-responsive">
                        <table class="table shopping-summery text-center clean">
                            <thead>
                            <tr class="main-heading">
                                <th scope="col">Image</th>
                                <th scope="col">Name</th>
                                <th scope="col">Price</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Remove</th>
                            </tr>
                            </thead>
                            <tbody>

                            <% if (userCart.items.length> 0) { %>
                                <% var x=0 %>
                                <% for (let i=0; i < userCart.items.length;i++) { %>

                                    <tr>

                                    <td class="image product-thumbnail">
                                        <img style="width: 40%;"
                                            src="/uploads/resized-images/<%= userCart.items[i].productDetails.productImage[0] %>" alt="#" />
                                        

                                    </td>
                                    <td class="product-des product-name">
                                        <h5 class="product-name">
                                        
                                            <%= userCart.items[i].productDetails.productName %>
                                        
                                        </h5>
                                        <p class="font-xs">
                                        <%= userCart.items[i].productDetails.category?.name %><br />
                                            <%= userCart.items[i].productDetails.brand?.brandName %>
                                        </p>
                                    </td>
                                    <td class="price" data-title="Price">‚Çπ
                                        <text id="subTotal<%= userCart.items[i].productDetails._id %>">
                                            <%= userCart.items[i].productDetails.salePrice * userCart.items[i].quantity %>
                                            <!-- <strike><%= userCart.items[i].productDetails.regularPrice * userCart.items[i].quantity %></strike> -->
                                        </text><br>
                                        
                                        <small class="text-muted text-nowrap">
                                            ‚Çπ<span id="price">
                                            <%= userCart.items[i].productDetails.salePrice %>
                                            ‚Çπ<strike><%= userCart.items[i].productDetails.regularPrice %></strike>
                                            </span>/ per item 
                                        </small>
                                    </td>

                                        <td class="text-center" data-title="Stock">
                                        <div class="detail-qty border radius m-auto">
                                            <div class="quantity-control">


                                            <% if(userCart.items[i].productDetails.quantity !==0 ){ %>
                                            <button class="btn btn-sm increment-button"
                                                onclick="changeQuantity(
                                                    '<%= userCart.items[i].productDetails._id %>',
                                                    1,
                                                    '<%= userCart.items[i].productDetails.salePrice %>',
                                                    '<%= grandTotal %>'
                                                )">+</button>


                                            <input class="quantity-input" id="cartProductQuantity<%= userCart.items[i].productDetails._id %>"
                                                value="<%=userCart.items[i].quantity %>" style="width: 45px;" type="text" readonly>


                                            <button class="btn btn-sm decrement-button"
                                                onclick="changeQuantity(
                                                    '<%= userCart.items[i].productDetails._id %>',
                                                    -1,
                                                    '<%= userCart.items[i].productDetails.salePrice %>',
                                                    '<%= grandTotal %>'
                                                )">-</button>
                                                <% }else{ %>
                                                <h5 class="text-danger">Out Of Stock</h5>
                                                <% } %>

                                            </div>
                                            <div>
                                            <strong id="outOfStockMessage" class="text-danger"></strong>
                                            </div>
                                        </div>
                                        </td>

                                        <td class="action" data-title="Remove">
                                        <a class="btn btn-sm" href="#"
                                            onclick="removeItem('<%= userCart.items[i].productDetails._id %>')">
                                            <i class="fi-rs-trash"></i>üóëÔ∏èRemove
                                        </a>
                                        </td>

                                        <% } %>

                                        <% } else { %>
                                    <tr>

                                    <td colspan="2" class="text-center">
                                        <p class="lead mb-4">No item found in Cart</p>
                                    </td>
                                    </tr>
                                    <% } %>

                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                    <h2>Choose Payment Method</h2>
                    <div>
                        <input type="radio" name="paymentOption" id="COD">
                        <strong><label for="COD"> Cash On Delivery </label></strong>
                    </div>
                    
                    <div>
                        <input type="radio" name="paymentOption" id="UPI">
                        <strong><label for="UPI"> UPI </label></strong>
                    </div>
            </div>

            <div class="row">
                <div class="col-9">
                    <div class="border p-md-4 p-30 border-radius cart-totals">
                        <div class="heading_s1 mb-3">
                            <h4>PRICE DETAILS</h4>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td class="cart_total_label">Shipping</td>
                                        <td class="cart_total_amount">
                                            <i class="ti-gift mr-5"></i>
                                            Free Shipping
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="cart_total_label">Total</td>
                                        <td class="cart_total_amount">
                                            <span class="font-lg fw-900 text-brand">‚Çπ
                                                <text id="grandTotal"><h2>
                                                        <%= grandTotal %>/-
                                                </h2></text>
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <a href="#" class="btn btn-success"> <i class="fi-rs-box-alt mr-10"></i>
                            Proceed
                        </a>
                    </div>
                </div>
            </div>
             <script>
                async function changeQuantity(productId,count,saleprice,grandTotal){
                    // console.log('changeQuantity() started');
                    document.getElementById('outOfStockMessage').innerHTML="";

                    console.log('salePrice======>',saleprice);
                    const currentQtyElement=document.getElementById(`cartProductQuantity${productId}`);
                    let currentQty=currentQtyElement.value;
                    const subtotalElement=document.getElementById(`subTotal${productId}`);
                    const grandTotalElement=document.getElementById('grandTotal');
                    // console.log('current Qty====>',currentQty);
                    if(parseInt(currentQty)+count > 3){
                        return Swal.fire({
                            title:"Maximum limit is 3",
                            icon:'warning',
                            timer:5000
                        })
                    }
                    if(parseInt(currentQty)+count <1){
                        console.log("minimum limit is 1")
                        return;
                    }


                    const response=await fetch('/change-cart-quantity',{
                        method:'post',
                        headers:{
                            'Content-Type':'application/json',
                        },
                        body:JSON.stringify({
                            productId:productId,
                            count:count
                        })
                    })

                    if(response.ok){
                        const result= await response.json()
                        // console.log("response ok")
                        // console.log(result.message);
                        if(result.status){
                            // console.log('cart qty increased')
                            // console.log(typeof currentQty)
                            let newQty=parseInt(currentQty)+count;
                            currentQtyElement.value=newQty;
                            // currentQtyElement.placeholder=newQty;
                            subtotalElement.innerHTML=parseFloat(saleprice) * newQty;
                            


                        }else{
                            // console.log("cart qty defaulted")
                            // console.log("cartProductQty=====>",result.cartProductQty)
                            let newQty=parseInt(result.updatedCartProductQty);
                            console.log("cartProductQty=====>",result.updatedCartProductQty)
                            if(newQty===0){
                            document.getElementById('outOfStockMessage').innerHTML="Out of Stock";
                            }
                            
                            currentQtyElement.value=newQty;
                            // currentQtyElement.placeholder=newQty;
                            subtotalElement.innerHTML=parseFloat(saleprice) * newQty;
                            Swal.fire({
                                title:"Sorry, Only limited stock available",
                                icon:"warning"
                            })
                        }
                        // Update grand total from backend
                        grandTotalElement.innerHTML =`<h2> ${result.grandTotal}/- </h2>`;
                        grandTotalElement.dataset.grandTotal=result.grandTotal;
                        
                    }

                }     

                async function removeItem(productId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, remove it!'
                }).then((result) => {
                if (result.isConfirmed) {
                        fetch(`/delete-cart-item/${productId}`, {
                            method: 'DELETE'
                        })
                        .then(res => {
                            if (res.ok) {
                            window.location.reload();
                            }
                        });
                        }

                })
                }

                document.addEventListener('DOMContentLoaded',()=>{
                const checkouPageLinkElement=document.getElementById('checkouPageLink');
                checkouPageLinkElement.addEventListener('click',(e)=>{
                    const grandTotalElement=document.getElementById('grandTotal');
                    const grandTotal=parseFloat (grandTotalElement.dataset.grandTotal);
                    console.log("grandTotal======>",grandTotal);
                    if(grandTotal===0){
                    e.preventDefault();
                    Swal.fire({
                        title:"Add products in the cart",
                        icon:"warning"
                    })
                    }
                })
                })

            </script>

        </div>

    </section>

   



    <%-include ('../../views/partials/user/footer') %>
