<style>
    .product-listing {
    padding: 2rem 0;
}

.product-card {
    border: 1px solid #eee;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.product-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transform: translateY(-5px);
}

.product-image-container {
    position: relative;
    overflow: hidden;
    padding-top: 100%; /* Square aspect ratio */
}

.product-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 1rem;
}

.product-actions {
    position: absolute;
    top: 10px;
    right: 10px;
}

.btn-wishlist {
    background: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
}

.product-name {
    font-size: 1rem;
    margin-bottom: 0.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.product-price {
    margin-bottom: 0.5rem;
}

.current-price {
    font-weight: bold;
    color: #d32f2f;
    font-size: 1.2rem;
}

.original-price {
    text-decoration: line-through;
    color: #999;
    font-size: 0.9rem;
    margin-left: 0.5rem;
}

.product-rating {
    color: #ffc107;
    margin-bottom: 1rem;
}

.rating-count {
    color: #666;
    font-size: 0.8rem;
}

.btn-add-to-cart {
    border-radius: 4px;
    font-weight: 500;
}

.carousel-container {
  position: relative;
  width: 100%;
  overflow: hidden;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.carousel-slide {
  display: flex;
  transition: transform 0.5s ease-in-out;
}

.carousel-slide img {
  width: 100%;
  /* height: 300px; */
  object-fit: cover;
}

#prevBtn, #nextBtn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 2rem;
  background: rgba(0,0,0,0.5);
  color: white;
  border: none;
  padding: 10px;
  cursor: pointer;
}

#prevBtn { left: 10px; }
#nextBtn { right: 10px; }
</style>

<%-include ('../../views/partials/user/header') %>
    
<div class="container">
    <nav class="navbar navbar-light bg-light">
        <form class="form-inline" action="/shop" method="get">
            <input class="form-control mr-sm-2" type="search" 
                    placeholder="Search products..." aria-label="Search"
                    name="search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
        </form>
    </nav>
</div>
<% if(banner){ %>
        <div class="container">
            <div class="carousel-container">
            <div class="carousel-slide">
                
                <% for(let i=0;i< banner.length;i++){ %>
                <img src="/uploads/resized-images/<%= banner[i].image %>" alt="<%= banner[i].title %>">
                 <% } %>
            </div>

            <button id="prevBtn">&#10094;</button>
            <button id="nextBtn">&#10095;</button>
        </div>
        </div>
<% } %>


<section class="product-listing">
    <div class="container">
        <div class="row">
            <h1>New Arrivals</h1>
            <% for(let i=0; i < products.length; i++){ %>
                <div class="col-md-4 col-sm-6 mb-4">
                    <div class="product-card card h-100">
                        <a href="/product-details?id=<%= products[i]._id %>">
                            <div class="product-image-container">
                                <img src="/uploads/product-images/<%= products[i].productImage[0] %>" 
                                    alt="<%= products[i].productName %>"
                                    class="product-image card-img-top">
                                <div class="product-actions">
                                    <button class="btn btn-sm btn-wishlist">
                                        <i class="far fa-heart"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="product-name card-title"><%= products[i].productName %></h5>
                                <div class="product-price">
                                    <span class="current-price">$<%= products[i].salePrice.toFixed() %></span>
                                    <% if(products[i].regularPrice) { %>
                                        <span class="original-price">$<%= products[i].regularPrice %></span>
                                    <% } %>
                                </div>
                                <div class="product-rating">
                                    <% for(let j=0; j < 5; j++) { %>
                                        <% if(j < products[i].rating) { %>
                                            <i class="fas fa-star"></i>
                                        <% } else { %>
                                            <i class="far fa-star"></i>
                                        <% } %>
                                    <% } %>
                                    <span class="rating-count">(<%= products[i].reviewCount %>)</span>
                                </div>
                            </div>
                        </a>
                        <div class="card-footer bg-white">
                           
                                <button id="addToCartBtn" onclick="addToCart('<%= products[i]._id %>')" class="btn btn-primary btn-block btn-add-to-cart">
                                    Add to Cart
                                </button>
                                <button id="addToWishlist" onclick="addToWishlist('<%= products[i]._id %>')" class="btn btn-outline-primary">
                                    Add to Wishlist
                                </button>
                            
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</section>

<%- include("../../views/partials/user/footer") %>

<script>
    //banner logic
    const carouselSlide = document.querySelector('.carousel-slide');
    const images = document.querySelectorAll('.carousel-slide img');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    let counter = 0;
    const size = images[0].clientWidth;

    // Move to next image
    nextBtn.addEventListener('click', () => {
        if (counter >= images.length - 1) return;
        counter++;
        carouselSlide.style.transform = `translateX(${-size * counter}px)`;
    });

    // Move to previous image
    prevBtn.addEventListener('click', () => {
        if (counter <= 0) return;
        counter--;
        carouselSlide.style.transform = `translateX(${-size * counter}px)`;
    });


    //////////////////////add to cart////////////////////////
    async function addToCart(productId) {
        try {
            const response=await fetch('/add-to-cart',{
                method:'post',
                headers:{
                    'Content-Type':'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body:JSON.stringify({productId:productId})
            })
            const responseJson=await response.json();
            console.log("responseJson:",responseJson)

            if(responseJson.status===true){
                await Swal.fire({
                    title:'Success',
                    text:'Item Added to Cart',
                    icon:'success',
                    timer:1000,
                    showConfirmButton:false
                })
                // update cart icon
                document.getElementById('cartCount').textContent = responseJson.cartLength;
            }else{
                throw new Error(responseJson.message || 'Failed to add to cart');
            }
        } catch (error) {
            console.error("Error:",error);
            console.log("error.message:",error.message)
            Swal.fire({
                title:error.message || 'Something went wrong',
                icon:'warning'
            })
        }
    }


    async function addToWishlist(productId) {
      try {
        const response=await fetch(`/wishlist/add/${productId}`,{
          method:"post",
          headers:{
            'Content-Type':'application/json'
          }
        });

        const result=await response.json();
        if(result.success){
          Swal.fire({
            title: "Added to Wishlist",
            icon: "success",
            timer: 1000,
            showConfirmButton: false
          });

        }else{
          Swal.fire({
            title:"Oops",
            text:result.message,
            icon:"error",
            timer:1000
          })
        }

      } catch (error) {
        console.log('addToWishlisht() error:',error);
        Swal.fire(
          "Something went wrong","","error"
        )
      }
    }
</script>