<style>
  /* Base Styles */
  :root {
    --primary-color: #4a90e2;
    --secondary-color: #f8f9fa;
    --text-color: #333;
    --light-text: #777;
    --border-color: #e1e1e1;
    --discount-color: #ff5252;
  }

  .shop-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .page-title {
    font-size: 2rem;
    color: var(--text-color);
    margin-bottom: 30px;
    font-weight: 600;
    text-align: center;
  }

  /* Layout */
  .shop-layout {
    display: flex;
    gap: 30px;
  }

  .filter-sidebar {
    flex: 0 0 280px;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    height: fit-content;
    position: sticky;
    top: 20px;
  }

  .product-main {
    flex: 1;
  }

  /* Filter Styles */
  .filter-section {
    margin-bottom: 25px;
    padding-bottom: 25px;
    border-bottom: 1px solid var(--border-color);
  }

  .filter-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .filter-heading {
    font-size: 1.1rem;
    margin-bottom: 15px;
    color: var(--text-color);
    font-weight: 500;
  }

  .search-box {
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 10px 15px 10px 35px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.95rem;
  }

  .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--light-text);
  }

  .sort-select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.95rem;
    background-color: white;
  }

  .price-range {
    display: flex;
    gap: 10px;
  }

  .price-input {
    flex: 1;
  }

  .price-input label {
    display: block;
    font-size: 0.85rem;
    margin-bottom: 5px;
    color: var(--light-text);
  }

  .price-input input {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
  }

  .filter-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .filter-option {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    position: relative;
    padding-left: 28px;
    user-select: none;
    font-size: 0.95rem;
  }

  .filter-option input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
  }

  .checkmark {
    position: absolute;
    left: 0;
    height: 18px;
    width: 18px;
    background-color: white;
    border: 1px solid var(--border-color);
    border-radius: 3px;
  }

  .filter-option:hover input ~ .checkmark {
    background-color: #f1f1f1;
  }

  .filter-option input:checked ~ .checkmark {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .checkmark:after {
    content: "";
    position: absolute;
    display: none;
  }

  .filter-option input:checked ~ .checkmark:after {
    display: block;
  }

  .filter-option .checkmark:after {
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .filter-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .btn {
    padding: 10px 15px;
    border-radius: 4px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    flex: 1;
    text-align: center;
  }

  .apply-btn {
    background-color: var(--primary-color);
    color: white;
  }

  .apply-btn:hover {
    background-color: #3a7bc8;
  }

  .clear-btn {
    background-color: white;
    color: var(--text-color);
    border: 1px solid var(--border-color);
  }

  .clear-btn:hover {
    background-color: var(--secondary-color);
  }

  /* Product Grid */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .product-card {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s, box-shadow 0.3s;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .product-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1;
  }

  .badge {
    background-color: var(--discount-color);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
  }

  .product-image-container {
    position: relative;
    padding-top: 100%;
    overflow: hidden;
  }

  .product-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .quick-view-btn {
    position: absolute;
    bottom: -40px;
    left: 0;
    width: 100%;
    padding: 8px;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    cursor: pointer;
    transition: bottom 0.3s;
    font-size: 0.9rem;
  }

  .product-card:hover .quick-view-btn {
    bottom: 0;
  }

  .product-info {
    padding: 15px;
  }

  .product-brand {
    font-size: 0.85rem;
    color: var(--light-text);
    margin-bottom: 5px;
  }

  .product-name {
    font-size: 1rem;
    color: var(--text-color);
    margin-bottom: 10px;
    font-weight: 500;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    min-height: 40px;
  }

  .product-pricing {
    margin-bottom: 15px;
  }

  .sale-price {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-color);
  }

  .regular-price {
    font-size: 0.9rem;
    color: var(--light-text);
    text-decoration: line-through;
    margin-left: 8px;
  }

  .add-to-cart-btn {
    width: 100%;
    padding: 8px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .add-to-cart-btn:hover {
    background-color: #3a7bc8;
  }

  /* No Products */
  .no-products {
    text-align: center;
    padding: 50px 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .no-products img {
    max-width: 200px;
    margin-bottom: 20px;
    opacity: 0.7;
  }

  .no-products h3 {
    font-size: 1.5rem;
    color: var(--text-color);
    margin-bottom: 10px;
  }

  .no-products p {
    color: var(--light-text);
    margin-bottom: 20px;
  }

  /* Pagination */
  .pagination-container {
    margin-top: 40px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px;
  }

  .page-link {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-color);
    text-decoration: none;
    transition: all 0.3s;
    font-size: 0.9rem;
  }

  .page-link:hover {
    background-color: var(--secondary-color);
  }

  .page-link.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }

  .page-numbers {
    display: flex;
    gap: 5px;
  }

  .prev, .next {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .shop-layout {
      flex-direction: column;
    }

    .filter-sidebar {
      position: static;
      margin-bottom: 30px;
    }

    .product-grid {
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    }

    .price-range {
      flex-direction: column;
    }
  }

  @media (max-width: 480px) {
    .product-grid {
      grid-template-columns: 1fr 1fr;
    }

    .pagination {
      flex-wrap: wrap;
    }
  }
</style>

<%- include("../../views/partials/user/header") %>

<div class="shop-container">
  <h1 class="page-title">Shop Products</h1>
  
  <div class="shop-layout">
    <!-- Sidebar Filters -->
    <aside class="filter-sidebar">
      <form action="/shop" method="GET" class="filter-form">
        <div class="filter-section">
          <h3 class="filter-heading">Search</h3>
          <div class="search-box">
            <input type="text" name="search" value="<%= search %>" placeholder="Search products..." class="search-input">
            <i class="fas fa-search search-icon"></i>
          </div>
        </div>

        <div class="filter-section">
          <h3 class="filter-heading">Sort By</h3>
          <select name="sort" class="sort-select">
            <option value="">Default</option>
            <option value="price-asc" <%= sort === 'price-asc' ? 'selected' : '' %>>Price: Low to High</option>
            <option value="price-desc" <%= sort === 'price-desc' ? 'selected' : '' %>>Price: High to Low</option>
            <option value="name-asc" <%= sort === 'name-asc' ? 'selected' : '' %>>Alphabetical A-Z</option>
            <option value="name-desc" <%= sort === 'name-desc' ? 'selected' : '' %>>Alphabetical Z-A</option>
          </select>
        </div>

        <div class="filter-section">
          <h3 class="filter-heading">Price Range</h3>
          <div class="price-range">
            <div class="price-input">
              <label>Min Price</label>
              <input type="number" name="minPrice" value="<%= minPrice %>" placeholder="Min" min="0">
            </div>
            <div class="price-input">
              <label>Max Price</label>
              <input type="number" name="maxPrice" value="<%= maxPrice %>" placeholder="Max" min="0">
            </div>
          </div>
        </div>

        <% if(categories && categories.length>0){ %>
          <div class="filter-section">
            <h3 class="filter-heading">Categories</h3>
            <div class="filter-options">
              <% for(let i=0;i < categories.length;i++){ %>
                <label class="filter-option">
                  <input type="checkbox" name="categoryIds" value="<%= categories[i]._id %>"
                       <%= categoryIds.includes(categories[i]._id.toString()) ? 'checked' : '' %>>
                  <span class="checkmark"></span>
                  <%= categories[i].name %>
                </label>
              <% } %>
            </div>
          </div>
        <% } %>

        <% if(brands && brands.length>0){ %>
          <div class="filter-section">
            <h3 class="filter-heading">Brands</h3>
            <div class="filter-options">
              <% for(let i=0;i < brands.length;i++){ %>
                <label class="filter-option">
                  <input type="checkbox" name="brandIds" value="<%= brands[i]._id %>"
                       <%= brandIds.includes(brands[i]._id.toString()) ? 'checked' : '' %>>
                  <span class="checkmark"></span>
                  <%= brands[i].brandName %>
                </label>
              <% } %>
            </div>
          </div>
        <% } %>

        <div class="filter-actions">
          <button type="submit" class="btn apply-btn">Apply Filters</button>
          <a href="/shop" class="btn clear-btn">Reset All</a>
        </div>
      </form>
    </aside>

    <!-- Main Content -->
    <main class="product-main">
      <% if(products && products.length > 0){ %>
        <div class="product-grid">
          <% for(let i=0;i < products.length; i++){ %>
            
              <div class="product-card">
                <div class="product-badge">
                  <% const discount = Math.round(((products[i].regularPrice - products[i].salePrice)/products[i].regularPrice)*100) %>
                  <% if(discount > 0) { %>
                    <span class="badge">-<%= discount %>%</span>
                  <% } %>
                </div>
                <a href="/product-details?id=<%= products[i]._id %>" style="text-decoration: none;">
                  <div class="product-image-container">
                    <img src="/uploads/product-images/<%= products[i].productImage[0] %>" alt="<%= products[i].productName %>" class="product-image">
                    <button class="quick-view-btn">Quick View</button>
                  </div>
                  <div class="product-info">
                    <div class="product-brand"><%= products[i].brand?.brandName %></div>
                    <h3 class="product-name"><%= products[i].productName %></h3>
                    <div class="product-pricing">
                      <span class="sale-price">Rs. <%= products[i].salePrice.toFixed(1) %></span>
                      <% if(products[i].regularPrice > products[i].salePrice) { %>
                        <span class="regular-price">Rs. <%= products[i].regularPrice %></span>
                      <% } %>
                    </div>
                  </div>
              </a>
              <% if(products[i].quantity===0){ %>
              <button class="btn btn-danger" disabled>Out of Stock</button>
              <% }else{ %>
              <button id="addToCartBtn" onclick="addToCart('<%= products[i]._id %>')" class="btn btn-primary">Add to cart</button>
              <% } %>
              <button id="addToWishlist" onclick="addToWishlist('<%= products[i]._id %>')" class="btn btn-outline-primary">Add to Wishlist</button>
            </div>
          
          
          <% } %>
        </div>
      <% } else { %>
        <div class="no-products">
          <img src="/images/no-products.svg" alt="No products found">
          <h3>No products found</h3>
          <p>Try adjusting your search or filter criteria</p>
          <a href="/shop" class="btn btn-primary">Clear Filters</a>
        </div>
      <% } %>

      <% if(products && products.length > 0) { %>
        <div class="pagination-container">
          <div class="pagination">
            <% if (currentPage > 1) { %>
              <a class="page-link prev" href="/shop?page=<%= currentPage - 1 %>">
                <i class="fas fa-chevron-left"></i> Previous
              </a>
            <% } %>

            <div class="page-numbers">
              <% for (let i = 1; i <= totalPages; i++) { %>
                <a class="page-link <%= currentPage === i ? 'active' : '' %>" href="/shop?page=<%= i %>"><%= i %></a>
              <% } %>
            </div>

            <% if (currentPage < totalPages) { %>
              <a class="page-link next" href="/shop?page=<%= currentPage + 1 %>">
                Next <i class="fas fa-chevron-right"></i>
              </a>
            <% } %>
          </div>
        </div>
      <% } %>
    </main>
  </div>
</div>

<script>
   //////////////////////add to cart////////////////////////
    async function addToCart(productId) {
        try {
            const response=await fetch('/add-to-cart',{
                method:'post',
                headers:{
                    'Content-Type':'application/json'
                },
                body:JSON.stringify({productId:productId})
            })
            const responseJson=await response.json();

            if(responseJson.status===true){
                await Swal.fire({
                    title:'Success',
                    text:'Item Added to Cart',
                    icon:'success',
                    timer:1000,
                    showConfirmButton:false
                })
                // update cart icon
                document.getElementById('cartCount').textContent = responseJson.cartLength;
            }else{
                throw new Error(responseJson.status || 'Failed to add to cart');
            }
        } catch (error) {
            console.error("Error:",error),
            Swal.fire({
                title:"Error",
                text:error.message || 'Something went wrong',
                icon:'warning'
            })
        }
    }

    async function addToWishlist(productId) {
      try {
        const response=await fetch('/wishlist/add',{
          method:"post",
          headers:{
            'Content-Type':'application/json'
          },
          body:JSON.stringify({productId:productId})
        });

        const result=await response.json();
        if(result.success){
          Swal.fire({
            title: "Added to Wishlist",
            icon: "success",
            timer: 1000,
            showConfirmButton: false
          });

        }else{
          Swal.fire({
            title:"Oops",
            text:result.message,
            icon:"error",
            timer:1000
          })
        }

      } catch (error) {
        console.log('addToWishlisht() error:',error);
        Swal.fire(
          "Something went wrong","","error"
        )
      }
    }
</script>
<%- include("../../views/partials/user/footer") %>

